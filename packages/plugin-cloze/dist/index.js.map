{"version":3,"file":"index.js","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/plugin-cloze\",\r\n  \"version\": \"2.2.0\",\r\n  \"description\": \"jsPsych plugin for displaying a cloze test and checking participants answers against a correct solution\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/plugin-cloze\"\r\n  },\r\n  \"author\": \"Philipp Sprengholz\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/plugins/cloze\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.1.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\"\r\n  }\r\n}\r\n","import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\nconst info = <const>{\r\n  name: \"cloze\",\r\n  version: version,\r\n  parameters: {\r\n    /** \r\n     * The cloze text to be displayed. Blanks are indicated by %% signs and automatically replaced by \r\n     * input fields. If there is a correct answer you want the system to check against, it must be typed\r\n     * between the two percentage signs (i.e. % correct solution %). If you would like to input multiple\r\n     * solutions, type a slash between each responses (i.e. %1/2/3%).\r\n     */\r\n    text: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: undefined,\r\n    },\r\n    /** Text of the button participants have to press for finishing the cloze test. */\r\n    button_text: {\r\n      type: ParameterType.STRING,\r\n      default: \"OK\",\r\n    },\r\n    /** \r\n     * Boolean value indicating if the answers given by participants should be compared\r\n     * against a correct solution given in `text` after the submit button was clicked. \r\n     * If ```true```, answers are checked and in case of differences, the ```mistake_fn``` \r\n     * is called. In this case, the trial does not automatically finish. If ```false```, \r\n     * no checks are performed and the trial ends when clicking the submit button. \r\n     */\r\n    check_answers: {\r\n      type: ParameterType.BOOL,\r\n      default: false,\r\n    },\r\n    /** \r\n     * Boolean value indicating if the answers given by participants should be checked for\r\n     * completion after the button was clicked. If ```true```, answers are not checked for\r\n     * completion and blank answers are allowed. The trial will then automatically finish \r\n     * upon the clicking the button. If ```false```, answers are checked for completion, \r\n     * and in case there are some fields with missing answers, the ```mistake_fn``` is called. \r\n     * In this case, the trial does not automatically finish. \r\n     */\r\n    allow_blanks: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n    /** Boolean value indicating if the solutions checker must be case sensitive. */\r\n    case_sensitivity: {\r\n      type: ParameterType.BOOL,\r\n      pretty_name: \"Case sensitivity\",\r\n      default: true,\r\n    },\r\n    /** \r\n     * Function called if either `check_answers` is `true` or `allow_blanks` is `false` \r\n     * and there is a discrepancy between the set answers and the answers provided, or \r\n     * if all input fields aren't filled out, respectively. \r\n     */\r\n    mistake_fn: {\r\n      type: ParameterType.FUNCTION,\r\n      default: () => {},\r\n    },\r\n    /**\r\n     * Boolean value indicating if the first input field should be focused when the trial starts.\r\n     * Enabled by default, but may be disabled especially if participants are using screen readers.\r\n     */\r\n    autofocus: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    }\r\n  },\r\n  data: {\r\n    /** Answers the participant gave. */\r\n    response: {\r\n      type: ParameterType.STRING,\r\n      array: true,\r\n    },\r\n  },\r\n  // prettier-ignore\r\n  citations: '__CITATIONS__',\r\n};\r\n\r\ntype Info = typeof info;\r\n\r\n/**\r\n * This plugin displays a text with certain words omitted. Participants are asked to replace the missing items. Responses are recorded when clicking a button. Responses can be evaluated and a function is called in case of either differences or incomplete answers, making it possible to inform participants about mistakes before proceeding.\r\n *\r\n * @author Philipp Sprengholz\r\n * @see {@link https://www.jspsych.org/latest/plugins/cloze/ cloze plugin documentation on jspsych.org}\r\n */\r\nclass ClozePlugin implements JsPsychPlugin<Info> {\r\n  static info = info;\r\n\r\n  constructor(private jsPsych: JsPsych) {}\r\n\r\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\r\n    var html = '<div class=\"cloze\">';\r\n    // odd elements are text, even elements are the blanks\r\n    var elements = trial.text.split(\"%\");\r\n    const solutions = this.getSolutions(trial.text, trial.case_sensitivity);\r\n\r\n    let solution_counter = 0;\r\n    for (var i = 0; i < elements.length; i++) {\r\n      if (i % 2 === 0) {\r\n        html += elements[i];\r\n      } else {\r\n        html += `<input type=\"text\" id=\"input${solution_counter}\" value=\"\">`;\r\n        solution_counter++;\r\n      }\r\n    }\r\n\r\n    html += \"</div>\";\r\n\r\n    display_element.innerHTML = html;\r\n\r\n    const check = () => {\r\n      var answers: string[] = [];\r\n      var answers_correct = true;\r\n      var answers_filled = true;\r\n\r\n      for (var i = 0; i < solutions.length; i++) {\r\n        var field = document.getElementById(\"input\" + i) as HTMLInputElement;\r\n        answers.push(\r\n          trial.case_sensitivity ? field.value.trim() : field.value.toLowerCase().trim()\r\n        );\r\n\r\n        if (trial.check_answers) {\r\n          if (!solutions[i].includes(answers[i])) {\r\n            field.style.color = \"red\";\r\n            answers_correct = false;\r\n          } else {\r\n            field.style.color = \"black\";\r\n          }\r\n        }\r\n        if (!trial.allow_blanks) {\r\n          if (answers[i] === \"\") {\r\n            answers_filled = false;\r\n          }\r\n        }\r\n      }\r\n\r\n      if ((trial.check_answers && !answers_correct) || (!trial.allow_blanks && !answers_filled)) {\r\n        trial.mistake_fn();\r\n      } else {\r\n        var trial_data = {\r\n          response: answers,\r\n        };\r\n\r\n        this.jsPsych.finishTrial(trial_data);\r\n      }\r\n    };\r\n\r\n    display_element.innerHTML +=\r\n      '<br><button class=\"jspsych-html-button-response-button\" type=\"button\" id=\"finish_cloze_button\">' +\r\n      trial.button_text +\r\n      \"</button>\";\r\n    display_element.querySelector(\"#finish_cloze_button\").addEventListener(\"click\", check);\r\n\r\n    if (trial.autofocus)\r\n      (display_element.querySelector(\"#input0\") as HTMLElement).focus();\r\n  }\r\n\r\n  private getSolutions(text: string, case_sensitive: boolean): string[][] {\r\n    const solutions: string[][] = [];\r\n    const elements = text.split(\"%\");\r\n\r\n    for (let i = 1; i < elements.length; i += 2) {\r\n      solutions.push(\r\n        case_sensitive ? elements[i].trim().split(\"/\") : elements[i].toLowerCase().trim().split(\"/\")\r\n      );\r\n    }\r\n\r\n    return solutions;\r\n  }\r\n\r\n  simulate(\r\n    trial: TrialType<Info>,\r\n    simulation_mode,\r\n    simulation_options: any,\r\n    load_callback: () => void\r\n  ) {\r\n    if (simulation_mode == \"data-only\") {\r\n      load_callback();\r\n      this.simulate_data_only(trial, simulation_options);\r\n    }\r\n    if (simulation_mode == \"visual\") {\r\n      this.simulate_visual(trial, simulation_options, load_callback);\r\n    }\r\n  }\r\n\r\n  private create_simulation_data(trial: TrialType<Info>, simulation_options) {\r\n    const solutions = this.getSolutions(trial.text, trial.case_sensitivity);\r\n    const responses: string[] = [];\r\n    for (const wordList of solutions) {\r\n      if (wordList.includes(\"\")) {\r\n        var word = this.jsPsych.randomization.randomWords({ exactly: 1 });\r\n        responses.push(word[0]);\r\n      } else {\r\n        responses.push(wordList[Math.floor(Math.random() * wordList.length)]);\r\n      }\r\n    }\r\n\r\n    const default_data = {\r\n      response: responses,\r\n    };\r\n\r\n    const data = this.jsPsych.pluginAPI.mergeSimulationData(default_data, simulation_options);\r\n\r\n    //this.jsPsych.pluginAPI.ensureSimulationDataConsistency(trial, data);\r\n\r\n    return data;\r\n  }\r\n\r\n  private simulate_data_only(trial: TrialType<Info>, simulation_options) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    this.jsPsych.finishTrial(data);\r\n  }\r\n\r\n  private simulate_visual(trial: TrialType<Info>, simulation_options, load_callback: () => void) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    const display_element = this.jsPsych.getDisplayElement();\r\n\r\n    this.trial(display_element, trial);\r\n    load_callback();\r\n\r\n    const inputs = display_element.querySelectorAll('input[type=\"text\"]');\r\n    let rt = this.jsPsych.randomization.sampleExGaussian(750, 200, 0.01, true);\r\n    for (let i = 0; i < data.response.length; i++) {\r\n      this.jsPsych.pluginAPI.fillTextInput(inputs[i] as HTMLInputElement, data.response[i], rt);\r\n      rt += this.jsPsych.randomization.sampleExGaussian(750, 200, 0.01, true);\r\n    }\r\n    this.jsPsych.pluginAPI.clickTarget(display_element.querySelector(\"#finish_cloze_button\"), rt);\r\n  }\r\n}\r\n\r\nexport default ClozePlugin;\r\n"],"names":[],"mappings":";;AAEE,IAAW,OAAA,GAAA,OAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EC4EA,SAAA,EAAA;AAAA;;GAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}