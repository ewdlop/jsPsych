{"version":3,"file":"index.browser.js","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/plugin-webgazer-init-camera\",\r\n  \"version\": \"2.1.0\",\r\n  \"description\": \"\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest  --passWithNoTests\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/plugin-webgazer-init-camera\"\r\n  },\r\n  \"author\": \"Josh de Leeuw\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/plugins/webgazer-init-camera\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.0.0\",\r\n    \"@jspsych/extension-webgazer\": \">=1.0.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/extension-webgazer\": \"^1.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\"\r\n  }\r\n}\r\n","import type WebGazerExtension from \"@jspsych/extension-webgazer\";\r\nimport { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\nconst info = <const>{\r\n  name: \"webgazer-init-camera\",\r\n  version: version,\r\n  parameters: {\r\n    /** Instructions for the participant to follow. */\r\n    instructions: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: `\r\n            <p>Position your head so that the webcam has a good view of your eyes.</p>\r\n            <p>Center your face in the box and look directly towards the camera.</p>\r\n            <p>It is important that you try and keep your head reasonably still throughout the experiment, so please take a moment to adjust your setup to be comfortable.</p>\r\n            <p>When your face is centered in the box and the box is green, you can click to continue.</p>`,\r\n    },\r\n    /** The text for the button that participants click to end the trial. */\r\n    button_text: {\r\n      type: ParameterType.STRING,\r\n      default: \"Continue\",\r\n    },\r\n  },\r\n  data: {\r\n    /** The time it took for webgazer to initialize. This can be a long time in some situations, so this\r\n     * value is recorded for troubleshooting when participants are reporting difficulty.\r\n     */\r\n    load_time: {\r\n      type: ParameterType.INT,\r\n    },\r\n  },\r\n  // prettier-ignore\r\n  citations: '__CITATIONS__',\r\n};\r\n\r\ntype Info = typeof info;\r\n\r\n/**\r\n * This plugin initializes the camera and helps the participant center their face in the camera view for\r\n * using the the [WebGazer extension](../extensions/webgazer.md). For a narrative description of eye\r\n * tracking with jsPsych, see the [eye tracking overview](../overview/eye-tracking.md).\r\n *\r\n * @author Josh de Leeuw\r\n * @see {@link https://www.jspsych.org/latest/plugins/webgazer-init-camera/ webgazer-init-camera plugin} and\r\n * {@link https://www.jspsych.org/latest/overview/eye-tracking/ eye-tracking overview} documentation on jspsych.org\r\n */\r\nclass WebgazerInitCameraPlugin implements JsPsychPlugin<Info> {\r\n  static info = info;\r\n\r\n  constructor(private jsPsych: JsPsych) {}\r\n\r\n  trial(display_element: HTMLElement, trial: TrialType<Info>, on_load: () => void) {\r\n    const extension = this.jsPsych.extensions.webgazer as WebGazerExtension;\r\n\r\n    let trial_complete;\r\n\r\n    var start_time = performance.now();\r\n    var load_time: number;\r\n\r\n    // function to end trial when it is time\r\n    const end_trial = () => {\r\n      extension.pause();\r\n      extension.hideVideo();\r\n\r\n      // gather the data to store for the trial\r\n      var trial_data = {\r\n        load_time: load_time,\r\n      };\r\n\r\n      document.querySelector(\"#webgazer-center-style\").remove();\r\n\r\n      // move on to the next trial\r\n      this.jsPsych.finishTrial(trial_data);\r\n\r\n      trial_complete();\r\n    };\r\n\r\n    const showTrial = () => {\r\n      on_load();\r\n\r\n      load_time = Math.round(performance.now() - start_time);\r\n\r\n      var style = `\r\n          <style id=\"webgazer-center-style\">\r\n            #webgazerVideoContainer { top: 20px !important; left: calc(50% - 160px) !important;}\r\n          </style>\r\n        `;\r\n      document.querySelector(\"head\").insertAdjacentHTML(\"beforeend\", style);\r\n\r\n      var html = `\r\n          <div id='webgazer-init-container' style='position: relative; width:100vw; height:100vh'>\r\n          </div>`;\r\n\r\n      display_element.innerHTML = html;\r\n\r\n      extension.showVideo();\r\n      extension.resume();\r\n\r\n      var wg_container = display_element.querySelector(\"#webgazer-init-container\");\r\n\r\n      wg_container.innerHTML = `\r\n          <div style='position: absolute; top: max(260px, 40%); left: calc(50% - 400px); width:800px;'>\r\n          ${trial.instructions}\r\n          <button id='jspsych-wg-cont' class='jspsych-btn' disabled>${trial.button_text}</button>\r\n          </div>`;\r\n\r\n      if (is_face_detect_green()) {\r\n        (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = false;\r\n      } else {\r\n        var observer = new MutationObserver(face_detect_event_observer);\r\n        observer.observe(document, {\r\n          attributes: true,\r\n          attributeFilter: [\"style\"],\r\n          subtree: true,\r\n        });\r\n      }\r\n\r\n      document.querySelector(\"#jspsych-wg-cont\").addEventListener(\"click\", () => {\r\n        if (observer) {\r\n          observer.disconnect();\r\n        }\r\n        end_trial();\r\n      });\r\n    };\r\n\r\n    if (!extension.isInitialized()) {\r\n      extension\r\n        .start()\r\n        .then(() => {\r\n          showTrial();\r\n        })\r\n        .catch((error) => {\r\n          console.log(error);\r\n          display_element.innerHTML = `<p>The experiment cannot continue because the eye tracker failed to start.</p>\r\n              <p>This may be because of a technical problem or because you did not grant permission for the page to use your camera.</p>`;\r\n        });\r\n    } else {\r\n      showTrial();\r\n    }\r\n\r\n    function is_face_detect_green() {\r\n      if (document.querySelector(\"#webgazerFaceFeedbackBox\")) {\r\n        return (\r\n          (document.querySelector(\"#webgazerFaceFeedbackBox\") as HTMLElement).style.borderColor ==\r\n          \"green\"\r\n        );\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    function face_detect_event_observer(mutationsList, observer) {\r\n      if (mutationsList[0].target == document.querySelector(\"#webgazerFaceFeedbackBox\")) {\r\n        if (\r\n          mutationsList[0].type == \"attributes\" &&\r\n          mutationsList[0].target.style.borderColor == \"green\"\r\n        ) {\r\n          (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = false;\r\n        }\r\n        if (\r\n          mutationsList[0].type == \"attributes\" &&\r\n          mutationsList[0].target.style.borderColor == \"red\"\r\n        ) {\r\n          (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    return new Promise((resolve) => {\r\n      trial_complete = resolve;\r\n    });\r\n  }\r\n}\r\n\r\nexport default WebgazerInitCameraPlugin;\r\n"],"names":[],"mappings":";;;EAEE,IAAW,OAAA,GAAA,OAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IC+BA,SAAA,EAAA;EAAA;;KAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}