{"version":3,"file":"index.js","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/plugin-visual-search-circle\",\r\n  \"version\": \"2.2.0\",\r\n  \"description\": \"jsPsych visual search circle plugin\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/plugin-visual-search-circle\"\r\n  },\r\n  \"author\": \"Josh de Leeuw\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/plugins/visual-search-circle\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.1.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\"\r\n  }\r\n}\r\n","import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\nconst info = <const>{\r\n  name: \"visual-search-circle\",\r\n  version: version,\r\n  parameters: {\r\n    /**\r\n     * Path to image file that is the search target. This parameter must specified when the stimuli set is\r\n     * defined using the `target`, `foil` and `set_size` parameters, but should NOT be specified when using\r\n     * the `stimuli` parameter.\r\n     */\r\n    target: {\r\n      type: ParameterType.IMAGE,\r\n      default: null,\r\n    },\r\n    /**\r\n     * Path to image file that is the foil/distractor. This image will be repeated for all distractors up to\r\n     * the `set_size` value. This parameter must specified when the stimuli set is defined using the `target`,\r\n     * `foil` and `set_size` parameters, but should NOT be specified when using the `stimuli` parameter.\r\n     */\r\n    foil: {\r\n      type: ParameterType.IMAGE,\r\n      default: null,\r\n    },\r\n    /**\r\n     * How many items should be displayed, including the target when `target_present` is `true`. The foil\r\n     * image will be repeated up to this value when `target_present` is `false`, or up to `set_size - 1`\r\n     * when `target_present` is `true`. This parameter must specified when using the `target`, `foil` and\r\n     * `set_size` parameters to define the stimuli set, but should NOT be specified when using the `stimuli`\r\n     * parameter.\r\n     */\r\n    set_size: {\r\n      type: ParameterType.INT,\r\n      default: null,\r\n    },\r\n    /**\r\n     * Array containing all of the image files to be displayed. This parameter must be specified when NOT\r\n     * using the `target`, `foil`, and `set_size` parameters to define the stimuli set.\r\n     */\r\n    stimuli: {\r\n      type: ParameterType.IMAGE,\r\n      default: [],\r\n      array: true,\r\n    },\r\n    /**\r\n     * Is the target present? This parameter must always be specified. When using the `target`, `foil` and\r\n     * `set_size` parameters, `false` means that the foil image will be repeated up to the set_size, and\r\n     * `true` means that the target will be presented along with the foil image repeated up to set_size - 1.\r\n     * When using the `stimuli` parameter, this parameter is only used to determine the response accuracy.\r\n     */\r\n    target_present: {\r\n      type: ParameterType.BOOL,\r\n      default: undefined,\r\n    },\r\n    /**\r\n     * Path to image file that is a fixation target. This parameter must always be specified.\r\n     */\r\n    fixation_image: {\r\n      type: ParameterType.IMAGE,\r\n      default: undefined,\r\n    },\r\n    /** Two element array indicating the height and width of the search array element images. */\r\n    target_size: {\r\n      type: ParameterType.INT,\r\n      array: true,\r\n      default: [50, 50],\r\n    },\r\n    /** Two element array indicating the height and width of the fixation image. */\r\n    fixation_size: {\r\n      type: ParameterType.INT,\r\n      array: true,\r\n      default: [16, 16],\r\n    },\r\n    /** The diameter of the search array circle in pixels. */\r\n    circle_diameter: {\r\n      type: ParameterType.INT,\r\n      default: 250,\r\n    },\r\n    /** The key to press if the target is present in the search array. */\r\n    target_present_key: {\r\n      type: ParameterType.KEY,\r\n      default: \"j\",\r\n    },\r\n    /** The key to press if the target is not present in the search array. */\r\n    target_absent_key: {\r\n      type: ParameterType.KEY,\r\n      default: \"f\",\r\n    },\r\n    /** The maximum amount of time the participant is allowed to search before the trial will continue. A value\r\n     * of null will allow the participant to search indefinitely.\r\n     */\r\n    trial_duration: {\r\n      type: ParameterType.INT,\r\n      default: null,\r\n    },\r\n    /** How long to show the fixation image for before the search array (in milliseconds). */\r\n    fixation_duration: {\r\n      type: ParameterType.INT,\r\n      default: 1000,\r\n    },\r\n    /** Whether to use randomized locations on the circle for the items. If `false`, then the first item will always show at the location specified by `location_first_item`. */\r\n    randomize_item_locations: {\r\n      type: ParameterType.BOOL,\r\n      pretty_name: \"Randomize item locations\",\r\n      default: true,\r\n    },\r\n    /** \r\n     * If `randomize_item_locations` is `false`, the location of the first item on the circle, in degrees.\r\n     * 0 degrees is above the fixation, and moving clockwise in the positive direction.\r\n    */\r\n    location_first_item: {\r\n      type: ParameterType.INT,\r\n      pretty_name: \"Location first item\",\r\n      default: 0,\r\n    },\r\n    /** If true, the trial will end when the participant makes a response. */\r\n    response_ends_trial: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n  },\r\n  data: {\r\n    /** True if the participant gave the correct response. */\r\n    correct: {\r\n      type: ParameterType.BOOL,\r\n    },\r\n    /** Indicates which key the participant pressed. */\r\n    response: {\r\n      type: ParameterType.STRING,\r\n    },\r\n    /** The response time in milliseconds for the participant to make a response. The time is measured from when the stimulus first appears on the screen until the participant's response. */\r\n    rt: {\r\n      type: ParameterType.INT,\r\n    },\r\n    /** The number of items in the search array. */\r\n    set_size: {\r\n      type: ParameterType.INT,\r\n    },\r\n    /** True if the target is present in the search array. */\r\n    target_present: {\r\n      type: ParameterType.BOOL,\r\n    },\r\n    /** Array where each element is the pixel value of the center of an image in the search array. If the target is present, then the first element will represent the location of the target. This will be encoded as a JSON string when data is saved using the `.json()` or `.csv()` functions. */\r\n    locations: {\r\n      type: ParameterType.INT,\r\n      array: true,\r\n    },\r\n  },\r\n  // prettier-ignore\r\n  citations: '__CITATIONS__',\r\n};\r\n\r\ntype Info = typeof info;\r\n\r\n/**\r\n * This plugin presents a customizable visual-search task modelled after [Wang, Cavanagh, & Green (1994)](http://dx.doi.org/10.3758/BF03206946).\r\n * The participant indicates whether or not a target is present among a set of distractors. The stimuli are displayed in a circle, evenly-spaced,\r\n * equidistant from a fixation point. \r\n *\r\n * @author Josh de Leeuw\r\n * @see {@link https://www.jspsych.org/latest/plugins/visual-search-circle/ visual-search-circle plugin documentation on jspsych.org}\r\n **/\r\nclass VisualSearchCirclePlugin implements JsPsychPlugin<Info> {\r\n  static info = info;\r\n\r\n  constructor(private jsPsych: JsPsych) {}\r\n\r\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\r\n    var paper_size = trial.circle_diameter + trial.target_size[0];\r\n\r\n    // fixation location\r\n    var fix_loc = this.generateFixationLoc(trial);\r\n\r\n    // check for correct combination of parameters and create stimuli set\r\n    var to_present = this.generatePresentationSet(trial);\r\n\r\n    // stimulus locations on the circle\r\n    var display_locs = this.generateDisplayLocs(to_present.length, trial);\r\n\r\n    // get target to draw on\r\n    display_element.innerHTML +=\r\n      '<div id=\"jspsych-visual-search-circle-container\" style=\"position: relative; width:' +\r\n      paper_size +\r\n      \"px; height:\" +\r\n      paper_size +\r\n      'px\"></div>';\r\n    var paper = display_element.querySelector(\"#jspsych-visual-search-circle-container\");\r\n\r\n    const show_fixation = () => {\r\n      // show fixation\r\n      //var fixation = paper.image(trial.fixation_image, fix_loc[0], fix_loc[1], trial.fixation_size[0], trial.fixation_size[1]);\r\n      paper.innerHTML +=\r\n        \"<img src='\" +\r\n        trial.fixation_image +\r\n        \"' style='position: absolute; top:\" +\r\n        fix_loc[0] +\r\n        \"px; left:\" +\r\n        fix_loc[1] +\r\n        \"px; width:\" +\r\n        trial.fixation_size[0] +\r\n        \"px; height:\" +\r\n        trial.fixation_size[1] +\r\n        \"px;'></img>\";\r\n\r\n      // wait\r\n      this.jsPsych.pluginAPI.setTimeout(() => {\r\n        // after wait is over\r\n        show_search_array();\r\n      }, trial.fixation_duration);\r\n    };\r\n\r\n    const response = {\r\n      rt: null,\r\n      key: null,\r\n      correct: false,\r\n    };\r\n\r\n    const end_trial = () => {\r\n      this.jsPsych.pluginAPI.cancelAllKeyboardResponses();\r\n\r\n      // data saving\r\n      const trial_data = {\r\n        correct: response.correct,\r\n        rt: response.rt,\r\n        response: response.key,\r\n        locations: display_locs,\r\n        target_present: trial.target_present,\r\n        set_size: trial.set_size,\r\n      };\r\n\r\n      // go to next trial\r\n      this.jsPsych.finishTrial(trial_data);\r\n    };\r\n\r\n    show_fixation();\r\n\r\n    const show_search_array = () => {\r\n      for (var i = 0; i < display_locs.length; i++) {\r\n        paper.innerHTML +=\r\n          \"<img src='\" +\r\n          to_present[i] +\r\n          \"' style='position: absolute; top:\" +\r\n          display_locs[i][0] +\r\n          \"px; left:\" +\r\n          display_locs[i][1] +\r\n          \"px; width:\" +\r\n          trial.target_size[0] +\r\n          \"px; height:\" +\r\n          trial.target_size[1] +\r\n          \"px;'></img>\";\r\n      }\r\n\r\n      const after_response = (info: { key: string; rt: number }) => {\r\n        var correct = false;\r\n\r\n        if (\r\n          (this.jsPsych.pluginAPI.compareKeys(info.key, trial.target_present_key) &&\r\n            trial.target_present) ||\r\n          (this.jsPsych.pluginAPI.compareKeys(info.key, trial.target_absent_key) &&\r\n            !trial.target_present)\r\n        ) {\r\n          correct = true;\r\n        }\r\n\r\n        response.rt = info.rt;\r\n        response.key = info.key;\r\n        response.correct = correct;\r\n\r\n        if (trial.response_ends_trial) {\r\n          end_trial();\r\n        }\r\n      };\r\n\r\n      const valid_keys = [trial.target_present_key, trial.target_absent_key];\r\n\r\n      const key_listener = this.jsPsych.pluginAPI.getKeyboardResponse({\r\n        callback_function: after_response,\r\n        valid_responses: valid_keys,\r\n        rt_method: \"performance\",\r\n        persist: false,\r\n        allow_held_key: false,\r\n      });\r\n\r\n      if (trial.trial_duration !== null) {\r\n        this.jsPsych.pluginAPI.setTimeout(() => {\r\n          if (!response.rt) {\r\n            this.jsPsych.pluginAPI.cancelKeyboardResponse(key_listener);\r\n          }\r\n\r\n          end_trial();\r\n        }, trial.trial_duration);\r\n      }\r\n    };\r\n  }\r\n\r\n  private generateFixationLoc(trial) {\r\n    var paper_size = trial.circle_diameter + trial.target_size[0];\r\n    return [\r\n      Math.floor(paper_size / 2 - trial.fixation_size[0] / 2),\r\n      Math.floor(paper_size / 2 - trial.fixation_size[1] / 2),\r\n    ];\r\n  }\r\n\r\n  private generateDisplayLocs(n_locs: number, trial: TrialType<Info>) {\r\n    // circle params\r\n    var diam = trial.circle_diameter; // pixels\r\n    var radi = diam / 2;\r\n    var paper_size = diam + trial.target_size[0];\r\n\r\n    // stimuli width, height\r\n    var stimh = trial.target_size[0];\r\n    var stimw = trial.target_size[1];\r\n    var hstimh = stimh / 2;\r\n    var hstimw = stimw / 2;\r\n\r\n    var display_locs = [];\r\n    var offset = trial.randomize_item_locations \r\n      ? Math.floor(Math.random() * 360)\r\n      : trial.location_first_item - 180; // makes it so 0 is up, moving clockwise\r\n    for (var i = 0; i < n_locs; i++) {\r\n      display_locs.push([\r\n        Math.floor(paper_size / 2 + this.cosd(offset + i * (360 / n_locs)) * radi - hstimw),\r\n        Math.floor(paper_size / 2 - this.sind(offset + i * (360 / n_locs)) * radi - hstimh),\r\n      ]);\r\n    }\r\n    return display_locs;\r\n  }\r\n\r\n  private generatePresentationSet(trial: TrialType<Info>) {\r\n    var to_present = [];\r\n    if (trial.target !== null && trial.foil !== null && trial.set_size !== null) {\r\n      if (trial.target_present) {\r\n        for (var i = 0; i < trial.set_size - 1; i++) {\r\n          to_present.push(trial.foil);\r\n        }\r\n        to_present.push(trial.target);\r\n      } else {\r\n        for (var i = 0; i < trial.set_size; i++) {\r\n          to_present.push(trial.foil);\r\n        }\r\n      }\r\n    } else if (trial.stimuli.length > 0) {\r\n      to_present = trial.stimuli;\r\n    } else {\r\n      console.error(\r\n        \"Error in visual-search-circle plugin: you must specify an array of images via the stimuli parameter OR specify the target, foil and set_size parameters.\"\r\n      );\r\n    }\r\n    return to_present;\r\n  }\r\n\r\n  private cosd(num: number) {\r\n    return Math.cos((num / 180) * Math.PI);\r\n  }\r\n\r\n  private sind(num: number) {\r\n    return Math.sin((num / 180) * Math.PI);\r\n  }\r\n\r\n  simulate(\r\n    trial: TrialType<Info>,\r\n    simulation_mode,\r\n    simulation_options: any,\r\n    load_callback: () => void\r\n  ) {\r\n    if (simulation_mode == \"data-only\") {\r\n      load_callback();\r\n      this.simulate_data_only(trial, simulation_options);\r\n    }\r\n    if (simulation_mode == \"visual\") {\r\n      this.simulate_visual(trial, simulation_options, load_callback);\r\n    }\r\n  }\r\n\r\n  private create_simulation_data(trial: TrialType<Info>, simulation_options) {\r\n    const key = this.jsPsych.pluginAPI.getValidKey([\r\n      trial.target_present_key,\r\n      trial.target_absent_key,\r\n    ]);\r\n    const set = this.generatePresentationSet(trial);\r\n\r\n    const default_data = {\r\n      correct: trial.target_present\r\n        ? key == trial.target_present_key\r\n        : key == trial.target_absent_key,\r\n      response: key,\r\n      rt: this.jsPsych.randomization.sampleExGaussian(500, 50, 1 / 150, true),\r\n      set_size: set.length,\r\n      target_present: trial.target_present,\r\n      locations: this.generateDisplayLocs(set.length, trial),\r\n    };\r\n\r\n    const data = this.jsPsych.pluginAPI.mergeSimulationData(default_data, simulation_options);\r\n\r\n    this.jsPsych.pluginAPI.ensureSimulationDataConsistency(trial, data);\r\n\r\n    return data;\r\n  }\r\n\r\n  private simulate_data_only(trial: TrialType<Info>, simulation_options) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    this.jsPsych.finishTrial(data);\r\n  }\r\n\r\n  private simulate_visual(trial: TrialType<Info>, simulation_options, load_callback: () => void) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    const display_element = this.jsPsych.getDisplayElement();\r\n\r\n    this.trial(display_element, trial);\r\n    load_callback();\r\n\r\n    if (data.rt !== null) {\r\n      this.jsPsych.pluginAPI.pressKey(data.response, trial.fixation_duration + data.rt);\r\n    }\r\n  }\r\n}\r\n\r\nexport default VisualSearchCirclePlugin;\r\n"],"names":[],"mappings":";;AAEE,IAAW,OAAA,GAAA,OAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ECqJA,SAAA,EAAA;AAAA;;GAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}