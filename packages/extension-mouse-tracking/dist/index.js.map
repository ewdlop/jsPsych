{"version":3,"file":"index.js","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/extension-mouse-tracking\",\r\n  \"version\": \"1.2.0\",\r\n  \"description\": \"jsPsych extension for mouse tracking\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/extension-mouse-tracking\"\r\n  },\r\n  \"author\": \"Josh de Leeuw\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/extensions/mouse-tracking\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.0.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\"\r\n  }\r\n}\r\n","import { JsPsych, JsPsychExtension, JsPsychExtensionInfo, ParameterType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\ninterface InitializeParameters {\r\n  /**\r\n   * The minimum time between samples for `mousemove` events in milliseconds.\r\n   * If `mousemove` events occur more rapidly than this limit, they will not be recorded.\r\n   * Use this if you want to keep the data files smaller and don't need high resolution\r\n   * tracking data. The default value of 0 means that all events will be recorded.\r\n   * @default 0\r\n   */\r\n  minimum_sample_time: number;\r\n}\r\n\r\ninterface OnStartParameters {\r\n  /**\r\n   * An array of string selectors. The selectors should identify one unique element on the page.\r\n   * The DOMRect of the element will be stored in the data.\r\n   */\r\n  targets?: Array<string>;\r\n  /**\r\n   * An array of mouse events to track. Can include `\"mousemove\"`, `\"mousedown\"`, and `\"mouseup\"`.\r\n   * @default ['mousemove']\r\n   */\r\n  events?: Array<string>;\r\n}\r\n\r\n/**\r\n * https://www.jspsych.org/latest/extensions/mouse-tracking/\r\n */\r\nclass MouseTrackingExtension implements JsPsychExtension {\r\n  static info: JsPsychExtensionInfo = {\r\n    name: \"mouse-tracking\",\r\n    version: version,\r\n    data: {\r\n      /**\r\n       * An array of objects containing mouse movement data for the trial. Each object has an `x`, a `y`,  a `t`, and an\r\n       * `event` property. The `x` and `y` properties specify the mouse coordinates in pixels relative to the top left\r\n       * corner of the viewport and `t` specifies the time in milliseconds since the start of the trial. The `event`\r\n       * will be either 'mousemove', 'mousedown', or 'mouseup' depending on which event was generated.\r\n       */\r\n      mouse_tracking_data: {\r\n        type: ParameterType.COMPLEX,\r\n        array: true,\r\n        nested: {\r\n          x: {\r\n            type: ParameterType.INT,\r\n          },\r\n          y: {\r\n            type: ParameterType.INT,\r\n          },\r\n          t: {\r\n            type: ParameterType.INT,\r\n          },\r\n          event: {\r\n            type: ParameterType.STRING,\r\n          },\r\n        },\r\n      },\r\n      /**\r\n       * An object contain the pixel coordinates of elements on the screen specified by the `.targets` parameter. Each key\r\n       * in this object will be a `selector` property, containing the CSS selector string used to find the element. The object\r\n       * corresponding to each key will contain `x` and `y` properties specifying the top-left corner of the object, `width`\r\n       * and `height` values, plus `top`, `bottom`, `left`, and `right` parameters which specify the\r\n       * [bounding rectangle](https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect) of the element.\r\n       */\r\n      mouse_tracking_targets: {\r\n        type: ParameterType.COMPLEX,\r\n        nested: {\r\n          x: {\r\n            type: ParameterType.INT,\r\n          },\r\n          y: {\r\n            type: ParameterType.INT,\r\n          },\r\n          width: {\r\n            type: ParameterType.INT,\r\n          },\r\n          height: {\r\n            type: ParameterType.INT,\r\n          },\r\n          top: {\r\n            type: ParameterType.INT,\r\n          },\r\n          bottom: {\r\n            type: ParameterType.INT,\r\n          },\r\n          left: {\r\n            type: ParameterType.INT,\r\n          },\r\n          right: {\r\n            type: ParameterType.INT,\r\n          },\r\n        },\r\n      },\r\n    },\r\n    // prettier-ignore\r\n    citations: '__CITATIONS__',\r\n  };\r\n\r\n  constructor(private jsPsych: JsPsych) {}\r\n\r\n  private domObserver: MutationObserver;\r\n  private currentTrialData: Array<object>;\r\n  private currentTrialTargets: Map<string, DOMRect>;\r\n  private currentTrialSelectors: Array<string>;\r\n  private currentTrialStartTime: number;\r\n  private minimumSampleTime: number;\r\n  private lastSampleTime: number;\r\n  private eventsToTrack: Array<string>;\r\n\r\n  initialize = async ({ minimum_sample_time = 0 }: InitializeParameters) => {\r\n    this.domObserver = new MutationObserver(this.mutationObserverCallback);\r\n    this.minimumSampleTime = minimum_sample_time;\r\n  };\r\n\r\n  on_start = (params: OnStartParameters): void => {\r\n    params = params || {};\r\n\r\n    this.currentTrialData = [];\r\n    this.currentTrialTargets = new Map();\r\n    this.currentTrialSelectors = params.targets || [];\r\n    this.lastSampleTime = null;\r\n    this.eventsToTrack = params.events || [\"mousemove\"];\r\n\r\n    this.domObserver.observe(this.jsPsych.getDisplayElement(), { childList: true });\r\n  };\r\n\r\n  on_load = () => {\r\n    // set current trial start time\r\n    this.currentTrialStartTime = performance.now();\r\n\r\n    // start data collection\r\n    if (this.eventsToTrack.includes(\"mousemove\")) {\r\n      window.addEventListener(\"mousemove\", this.mouseMoveEventHandler);\r\n    }\r\n    if (this.eventsToTrack.includes(\"mousedown\")) {\r\n      window.addEventListener(\"mousedown\", this.mouseDownEventHandler);\r\n    }\r\n    if (this.eventsToTrack.includes(\"mouseup\")) {\r\n      window.addEventListener(\"mouseup\", this.mouseUpEventHandler);\r\n    }\r\n  };\r\n\r\n  on_finish = () => {\r\n    this.domObserver.disconnect();\r\n\r\n    if (this.eventsToTrack.includes(\"mousemove\")) {\r\n      window.removeEventListener(\"mousemove\", this.mouseMoveEventHandler);\r\n    }\r\n    if (this.eventsToTrack.includes(\"mousedown\")) {\r\n      window.removeEventListener(\"mousedown\", this.mouseDownEventHandler);\r\n    }\r\n    if (this.eventsToTrack.includes(\"mouseup\")) {\r\n      window.removeEventListener(\"mouseup\", this.mouseUpEventHandler);\r\n    }\r\n\r\n    return {\r\n      mouse_tracking_data: this.currentTrialData,\r\n      mouse_tracking_targets: Object.fromEntries(this.currentTrialTargets.entries()),\r\n    };\r\n  };\r\n\r\n  private mouseMoveEventHandler = ({ clientX: x, clientY: y }: MouseEvent) => {\r\n    const event_time = performance.now();\r\n    const t = Math.round(event_time - this.currentTrialStartTime);\r\n\r\n    if (\r\n      this.lastSampleTime === null ||\r\n      event_time - this.lastSampleTime >= this.minimumSampleTime\r\n    ) {\r\n      this.lastSampleTime = event_time;\r\n      this.currentTrialData.push({ x, y, t, event: \"mousemove\" });\r\n    }\r\n  };\r\n\r\n  private mouseUpEventHandler = ({ clientX: x, clientY: y }: MouseEvent) => {\r\n    const event_time = performance.now();\r\n    const t = Math.round(event_time - this.currentTrialStartTime);\r\n\r\n    this.currentTrialData.push({ x, y, t, event: \"mouseup\" });\r\n  };\r\n\r\n  private mouseDownEventHandler = ({ clientX: x, clientY: y }: MouseEvent) => {\r\n    const event_time = performance.now();\r\n    const t = Math.round(event_time - this.currentTrialStartTime);\r\n\r\n    this.currentTrialData.push({ x, y, t, event: \"mousedown\" });\r\n  };\r\n\r\n  private mutationObserverCallback = (mutationsList, observer) => {\r\n    for (const selector of this.currentTrialSelectors) {\r\n      if (!this.currentTrialTargets.has(selector)) {\r\n        const target = this.jsPsych.getDisplayElement().querySelector(selector);\r\n        if (target) {\r\n          this.currentTrialTargets.set(selector, target.getBoundingClientRect());\r\n        }\r\n      }\r\n    }\r\n  };\r\n}\r\n\r\nexport default MouseTrackingExtension;\r\n"],"names":[],"mappings":";;AAEE,IAAW,OAAA,GAAA,OAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MCgGE,SAAA,EAAA;AAAA;;OAAe;AAAA;;;;;;"}