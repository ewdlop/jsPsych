var jsPsychHtmlAudioResponse=function(a){"use strict";var n="2.1.1";const l={name:"html-audio-response",version:n,parameters:{stimulus:{type:a.ParameterType.HTML_STRING,default:void 0},stimulus_duration:{type:a.ParameterType.INT,default:null},recording_duration:{type:a.ParameterType.INT,default:2e3},show_done_button:{type:a.ParameterType.BOOL,default:!0},done_button_label:{type:a.ParameterType.STRING,default:"Continue"},record_again_button_label:{type:a.ParameterType.STRING,default:"Record again"},accept_button_label:{type:a.ParameterType.STRING,default:"Continue"},allow_playback:{type:a.ParameterType.BOOL,default:!1},save_audio_url:{type:a.ParameterType.BOOL,default:!1}},data:{rt:{type:a.ParameterType.INT},response:{type:a.ParameterType.STRING},stimulus:{type:a.ParameterType.HTML_STRING},estimated_stimulus_onset:{type:a.ParameterType.INT},audio_url:{type:a.ParameterType.STRING}},citations:{apa:"de Leeuw, J. R., Gilbert, R. A., & Luchterhandt, B. (2023). jsPsych: Enabling an Open-Source Collaborative Ecosystem of Behavioral Experiments. Journal of Open Source Software, 8(85), 5351. https://doi.org/10.21105/joss.05351 ",bibtex:'@article{Leeuw2023jsPsych, 	author = {de Leeuw, Joshua R. and Gilbert, Rebecca A. and Luchterhandt, Bj{\\" o}rn}, 	journal = {Journal of Open Source Software}, 	doi = {10.21105/joss.05351}, 	issn = {2475-9066}, 	number = {85}, 	year = {2023}, 	month = {may 11}, 	pages = {5351}, 	publisher = {Open Journals}, 	title = {jsPsych: Enabling an {Open}-{Source} {Collaborative} {Ecosystem} of {Behavioral} {Experiments}}, 	url = {https://joss.theoj.org/papers/10.21105/joss.05351}, 	volume = {8}, }  '}};class o{constructor(t){this.jsPsych=t,this.rt=null,this.recorded_data_chunks=[]}trial(t,e){this.recorder=this.jsPsych.pluginAPI.getMicrophoneRecorder(),this.setupRecordingEvents(t,e),this.startRecording()}showDisplay(t,e){new ResizeObserver((s,i)=>{this.stimulus_start_time=performance.now(),i.unobserve(t)}).observe(t);let r=`<div id="jspsych-html-audio-response-stimulus">${e.stimulus}</div>`;e.show_done_button&&(r+=`<p><button class="jspsych-btn" id="finish-trial">${e.done_button_label}</button></p>`),t.innerHTML=r}hideStimulus(t){const e=t.querySelector("#jspsych-html-audio-response-stimulus");e&&(e.style.visibility="hidden")}addButtonEvent(t,e){const r=t.querySelector("#finish-trial");r&&r.addEventListener("click",()=>{const s=performance.now();this.rt=Math.round(s-this.stimulus_start_time),this.stopRecording().then(()=>{e.allow_playback?this.showPlaybackControls(t,e):this.endTrial(t,e)})})}setupRecordingEvents(t,e){this.data_available_handler=r=>{r.data.size>0&&this.recorded_data_chunks.push(r.data)},this.stop_event_handler=()=>{const r=new Blob(this.recorded_data_chunks,{type:this.recorded_data_chunks[0].type});this.audio_url=URL.createObjectURL(r);const s=new FileReader;s.addEventListener("load",()=>{const i=s.result.split(",")[1];this.response=i,this.load_resolver()}),s.readAsDataURL(r)},this.start_event_handler=r=>{this.recorded_data_chunks.length=0,this.recorder_start_time=r.timeStamp,this.showDisplay(t,e),this.addButtonEvent(t,e),e.stimulus_duration!==null&&this.jsPsych.pluginAPI.setTimeout(()=>{this.hideStimulus(t)},e.stimulus_duration),e.recording_duration!==null&&this.jsPsych.pluginAPI.setTimeout(()=>{this.recorder.state!=="inactive"&&this.stopRecording().then(()=>{e.allow_playback?this.showPlaybackControls(t,e):this.endTrial(t,e)})},e.recording_duration)},this.recorder.addEventListener("dataavailable",this.data_available_handler),this.recorder.addEventListener("stop",this.stop_event_handler),this.recorder.addEventListener("start",this.start_event_handler)}startRecording(){this.recorder.start()}stopRecording(){return this.recorder.stop(),new Promise(t=>{this.load_resolver=t})}showPlaybackControls(t,e){t.innerHTML=`
      <p><audio id="playback" src="${this.audio_url}" controls></audio></p>
      <button id="record-again" class="jspsych-btn">${e.record_again_button_label}</button>
      <button id="continue" class="jspsych-btn">${e.accept_button_label}</button>
    `,t.querySelector("#record-again").addEventListener("click",()=>{URL.revokeObjectURL(this.audio_url),this.startRecording()}),t.querySelector("#continue").addEventListener("click",()=>{this.endTrial(t,e)})}endTrial(t,e){this.recorder.removeEventListener("dataavailable",this.data_available_handler),this.recorder.removeEventListener("start",this.start_event_handler),this.recorder.removeEventListener("stop",this.stop_event_handler);var r={rt:this.rt,stimulus:e.stimulus,response:this.response,estimated_stimulus_onset:Math.round(this.stimulus_start_time-this.recorder_start_time)};e.save_audio_url?r.audio_url=this.audio_url:URL.revokeObjectURL(this.audio_url),this.jsPsych.finishTrial(r)}}return o.info=l,o}(jsPsychModule);
//# sourceMappingURL=index.browser.min.js.map
