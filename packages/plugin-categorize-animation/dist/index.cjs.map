{"version":3,"file":"index.cjs","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/plugin-categorize-animation\",\r\n  \"version\": \"2.1.0\",\r\n  \"description\": \"jspsych plugin for categorization trials with feedback and animated stimuli\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/plugin-categorize-animation\"\r\n  },\r\n  \"author\": \"Josh de Leeuw\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/plugins/categorize-animation\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.1.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\"\r\n  }\r\n}\r\n","import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\nconst info = <const>{\r\n  name: \"categorize-animation\",\r\n  version: version,\r\n  parameters: {\r\n    /** Each element of the array is a path to an image file. */\r\n    stimuli: {\r\n      type: ParameterType.IMAGE,\r\n      default: undefined,\r\n      array: true,\r\n    },\r\n    /** The key character indicating the correct response. */\r\n    key_answer: {\r\n      type: ParameterType.KEY,\r\n      default: undefined,\r\n    },\r\n    /** This array contains the key(s) that the participant is allowed to press in order to respond to the stimulus. Keys should be specified as characters (e.g., `'a'`, `'q'`, `' '`, `'Enter'`, `'ArrowDown'`) - see [this page](https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key/Key_Values) and [this page (event.key column)](https://www.freecodecamp.org/news/javascript-keycode-list-keypress-event-key-codes/) for more examples. Any key presses that are not listed in the array will be ignored. The default value of `\"ALL_KEYS\"` means that all keys will be accepted as valid responses. Specifying `\"NO_KEYS\"` will mean that no responses are allowed. */\r\n    choices: {\r\n      type: ParameterType.KEYS,\r\n      default: \"ALL_KEYS\",\r\n    },\r\n    /** A text label that describes the correct answer. Used in conjunction with the `correct_text` and `incorrect_text` parameters. */\r\n    text_answer: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: null,\r\n    },\r\n    /** String to show when the correct answer is given. Can contain HTML formatting. The special string `%ANS%` can be used within the string. If present, the plugin will put the `text_answer` for the trial in place of the %ANS% string (see example below). */\r\n    correct_text: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: \"Correct.\",\r\n    },\r\n    /** String to show when the wrong answer is given. Can contain HTML formatting. The special string `%ANS%` can be used within the string. If present, the plugin will put the `text_answer` for the trial in place of the %ANS% string (see example below). */\r\n    incorrect_text: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: \"Wrong.\",\r\n    },\r\n    /** How long to display each image (in milliseconds). */\r\n    frame_time: {\r\n      type: ParameterType.INT,\r\n      default: 500,\r\n    },\r\n    /** How many times to show the entire sequence. */\r\n    sequence_reps: {\r\n      type: ParameterType.INT,\r\n      default: 1,\r\n    },\r\n    /** If true, the participant can respond before the animation sequence finishes. */\r\n    allow_response_before_complete: {\r\n      type: ParameterType.BOOL,\r\n      default: false,\r\n    },\r\n    /** How long to show the feedback (milliseconds). */\r\n    feedback_duration: {\r\n      type: ParameterType.INT,\r\n      default: 2000,\r\n    },\r\n    /** This string can contain HTML markup. Any content here will be displayed below the stimulus or the end of the animation depending on the allow_response_before_complete parameter. The intention is that it can be used to provide a reminder about the action the participant is supposed to take (e.g., which key to press). */\r\n    prompt: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: null,\r\n    },\r\n    /**\r\n     * If true, the images will be drawn onto a canvas element. This prevents a blank screen (white flash) between consecutive images in some browsers, like Firefox and Edge.\r\n     * If false, the image will be shown via an img element, as in previous versions of jsPsych.\r\n     */\r\n    render_on_canvas: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n  },\r\n  data: {\r\n    /** Array of stimuli displayed in the trial. This will be encoded as a JSON string when data is saved using the `.json()` or `.csv()` functions. */\r\n    stimulus: {\r\n      type: ParameterType.STRING,\r\n      array: true,\r\n    },\r\n    /** Indicates which key the participant pressed.  */\r\n    response: {\r\n      type: ParameterType.STRING,\r\n    },\r\n    /** The response time in milliseconds for the participant to make a response. The time is measured from when the stimulus first appears on the screen until the participant's response. */\r\n    rt: {\r\n      type: ParameterType.INT,\r\n    },\r\n    /** `true` if the participant got the correct answer, `false` otherwise. */\r\n    correct: {\r\n      type: ParameterType.BOOL,\r\n    },\r\n  },\r\n  // prettier-ignore\r\n  citations: '__CITATIONS__',\r\n};\r\n\r\ntype Info = typeof info;\r\n\r\n/**\r\n * The categorize animation plugin shows a sequence of images at a specified frame rate. The participant responds by pressing a key. Feedback indicating the correctness of the response is given.\r\n *\r\n * @author Josh de Leeuw\r\n * @see {@link https://www.jspsych.org/latest/plugins/categorize-animation/ categorize-animation plugin documentation on jspsych.org}\r\n */\r\nclass CategorizeAnimationPlugin implements JsPsychPlugin<Info> {\r\n  static info = info;\r\n\r\n  constructor(private jsPsych: JsPsych) {}\r\n\r\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\r\n    var animate_frame = 0;\r\n    var reps = 0;\r\n\r\n    var showAnimation = true;\r\n\r\n    var responded = false;\r\n    var timeoutSet = false;\r\n    var correct;\r\n\r\n    if (trial.render_on_canvas) {\r\n      // first clear the display element (because the render_on_canvas method appends to display_element instead of overwriting it with .innerHTML)\r\n      if (display_element.hasChildNodes()) {\r\n        // can't loop through child list because the list will be modified by .removeChild()\r\n        while (display_element.firstChild) {\r\n          display_element.removeChild(display_element.firstChild);\r\n        }\r\n      }\r\n      var canvas = document.createElement(\"canvas\");\r\n      canvas.id = \"jspsych-categorize-animation-stimulus\";\r\n      canvas.style.margin = \"0\";\r\n      canvas.style.padding = \"0\";\r\n      display_element.insertBefore(canvas, null);\r\n      var ctx = canvas.getContext(\"2d\");\r\n      if (trial.prompt !== null) {\r\n        var prompt_div = document.createElement(\"div\");\r\n        prompt_div.id = \"jspsych-categorize-animation-prompt\";\r\n        prompt_div.style.visibility = \"hidden\";\r\n        prompt_div.innerHTML = trial.prompt;\r\n        display_element.insertBefore(prompt_div, canvas.nextElementSibling);\r\n      }\r\n      var feedback_div = document.createElement(\"div\");\r\n      display_element.insertBefore(feedback_div, display_element.nextElementSibling);\r\n    }\r\n\r\n    const update_display = () => {\r\n      if (showAnimation) {\r\n        if (trial.render_on_canvas) {\r\n          display_element.querySelector<HTMLElement>(\r\n            \"#jspsych-categorize-animation-stimulus\"\r\n          ).style.visibility = \"visible\";\r\n          var img = new Image();\r\n          img.src = trial.stimuli[animate_frame];\r\n          canvas.height = img.naturalHeight;\r\n          canvas.width = img.naturalWidth;\r\n          ctx.drawImage(img, 0, 0);\r\n        } else {\r\n          display_element.innerHTML +=\r\n            '<img src=\"' +\r\n            trial.stimuli[animate_frame] +\r\n            '\" class=\"jspsych-categorize-animation-stimulus\"></img>';\r\n        }\r\n      }\r\n\r\n      if (!responded && trial.allow_response_before_complete) {\r\n        // in here if the user can respond before the animation is done\r\n        if (trial.prompt !== null) {\r\n          if (trial.render_on_canvas) {\r\n            prompt_div.style.visibility = \"visible\";\r\n          } else {\r\n            display_element.innerHTML += trial.prompt;\r\n          }\r\n        }\r\n        if (trial.render_on_canvas) {\r\n          if (!showAnimation) {\r\n            canvas.remove();\r\n          }\r\n        }\r\n      } else if (!responded) {\r\n        // in here if the user has to wait to respond until animation is done.\r\n        // if this is the case, don't show the prompt until the animation is over.\r\n        if (!showAnimation) {\r\n          if (trial.prompt !== null) {\r\n            if (trial.render_on_canvas) {\r\n              prompt_div.style.visibility = \"visible\";\r\n            } else {\r\n              display_element.innerHTML += trial.prompt;\r\n            }\r\n          }\r\n          if (trial.render_on_canvas) {\r\n            canvas.remove();\r\n          }\r\n        }\r\n      } else {\r\n        // user has responded if we get here.\r\n\r\n        // show feedback\r\n        var feedback_text = \"\";\r\n        if (correct) {\r\n          feedback_text = trial.correct_text.replace(\"%ANS%\", trial.text_answer);\r\n        } else {\r\n          feedback_text = trial.incorrect_text.replace(\"%ANS%\", trial.text_answer);\r\n        }\r\n        if (trial.render_on_canvas) {\r\n          if (trial.prompt !== null) {\r\n            prompt_div.remove();\r\n          }\r\n          feedback_div.innerHTML = feedback_text;\r\n        } else {\r\n          display_element.innerHTML += feedback_text;\r\n        }\r\n\r\n        // set timeout to clear feedback\r\n        if (!timeoutSet) {\r\n          timeoutSet = true;\r\n          this.jsPsych.pluginAPI.setTimeout(() => {\r\n            endTrial();\r\n          }, trial.feedback_duration);\r\n        }\r\n      }\r\n    };\r\n\r\n    // show animation\r\n    var animate_interval = setInterval(() => {\r\n      if (!trial.render_on_canvas) {\r\n        display_element.innerHTML = \"\"; // clear everything\r\n      }\r\n      animate_frame++;\r\n      if (animate_frame == trial.stimuli.length) {\r\n        animate_frame = 0;\r\n        reps++;\r\n        // check if reps complete //\r\n        if (trial.sequence_reps != -1 && reps >= trial.sequence_reps) {\r\n          // done with animation\r\n          showAnimation = false;\r\n        }\r\n      }\r\n\r\n      update_display();\r\n    }, trial.frame_time);\r\n\r\n    update_display();\r\n\r\n    const endTrial = () => {\r\n      clearInterval(animate_interval); // stop animation!\r\n      this.jsPsych.finishTrial(trial_data);\r\n    };\r\n\r\n    var keyboard_listener;\r\n    var trial_data = {};\r\n\r\n    // @ts-expect-error Error is: Unreachable code detected: Not all code paths return a value\r\n    const after_response = (info: { key: string; rt: number }) => {\r\n      // ignore the response if animation is playing and subject\r\n      // not allowed to respond before it is complete\r\n      if (!trial.allow_response_before_complete && showAnimation) {\r\n        return false;\r\n      }\r\n\r\n      correct = false;\r\n      if (this.jsPsych.pluginAPI.compareKeys(trial.key_answer, info.key)) {\r\n        correct = true;\r\n      }\r\n\r\n      responded = true;\r\n\r\n      trial_data = {\r\n        stimulus: trial.stimuli,\r\n        rt: info.rt,\r\n        correct: correct,\r\n        response: info.key,\r\n      };\r\n\r\n      this.jsPsych.pluginAPI.cancelKeyboardResponse(keyboard_listener);\r\n    };\r\n\r\n    keyboard_listener = this.jsPsych.pluginAPI.getKeyboardResponse({\r\n      callback_function: after_response,\r\n      valid_responses: trial.choices,\r\n      rt_method: \"performance\",\r\n      persist: true,\r\n      allow_held_key: false,\r\n    });\r\n  }\r\n\r\n  simulate(\r\n    trial: TrialType<Info>,\r\n    simulation_mode,\r\n    simulation_options: any,\r\n    load_callback: () => void\r\n  ) {\r\n    if (simulation_mode == \"data-only\") {\r\n      load_callback();\r\n      this.simulate_data_only(trial, simulation_options);\r\n    }\r\n    if (simulation_mode == \"visual\") {\r\n      this.simulate_visual(trial, simulation_options, load_callback);\r\n    }\r\n  }\r\n\r\n  private create_simulation_data(trial: TrialType<Info>, simulation_options) {\r\n    const animation_length = trial.sequence_reps * trial.frame_time * trial.stimuli.length;\r\n    const key = this.jsPsych.pluginAPI.getValidKey(trial.choices);\r\n\r\n    const default_data = {\r\n      stimulus: trial.stimuli,\r\n      rt: animation_length + this.jsPsych.randomization.sampleExGaussian(500, 50, 1 / 150, true),\r\n      response: key,\r\n      correct: key == trial.key_answer,\r\n    };\r\n\r\n    const data = this.jsPsych.pluginAPI.mergeSimulationData(default_data, simulation_options);\r\n\r\n    this.jsPsych.pluginAPI.ensureSimulationDataConsistency(trial, data);\r\n\r\n    return data;\r\n  }\r\n\r\n  private simulate_data_only(trial: TrialType<Info>, simulation_options) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    if (data.rt == null || data.response == null) {\r\n      throw new Error(`\r\n        Simulated response for categorize-animation plugin was invalid. \r\n        This could be because the response RT was too fast and generated\r\n        before the animation finished when the allow_response_before_complete\r\n        parameter is false. In a real experiment this would cause the experiment\r\n        to pause indefinitely.`);\r\n    } else {\r\n      this.jsPsych.finishTrial(data);\r\n    }\r\n  }\r\n\r\n  private simulate_visual(trial: TrialType<Info>, simulation_options, load_callback: () => void) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    const display_element = this.jsPsych.getDisplayElement();\r\n\r\n    this.trial(display_element, trial);\r\n    load_callback();\r\n\r\n    if (data.rt !== null) {\r\n      this.jsPsych.pluginAPI.pressKey(data.response, data.rt);\r\n    } else {\r\n      throw new Error(`\r\n        Simulated response for categorize-animation plugin was invalid. \r\n        This could be because the response RT was too fast and generated\r\n        before the animation finished when the allow_response_before_complete\r\n        parameter is false. In a real experiment this would cause the experiment\r\n        to pause indefinitely.`);\r\n    }\r\n  }\r\n}\r\n\r\nexport default CategorizeAnimationPlugin;\r\n"],"names":[],"mappings":";;;;AAEE,IAAW,OAAA,GAAA,OAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EC2FA,SAAA,EAAA;AAAA;;GAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}