{"version":3,"file":"index.browser.min.js","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/plugin-preload\",\r\n  \"version\": \"2.1.0\",\r\n  \"description\": \"\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/plugin-preload\"\r\n  },\r\n  \"author\": \"Josh de Leeuw\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/plugins/preload\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.1.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/plugin-audio-keyboard-response\": \"*\",\r\n    \"@jspsych/plugin-image-keyboard-response\": \"*\",\r\n    \"@jspsych/plugin-video-keyboard-response\": \"*\"\r\n  }\r\n}\r\n","import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\nconst info = <const>{\r\n  name: \"preload\",\r\n  version: version,\r\n  parameters: {\r\n    /** If `true`, the plugin will preload any files that can be automatically preloaded based on the main experiment\r\n     * timeline that is passed to `jsPsych.run`. If `false`, any file(s) to be preloaded should be specified by passing\r\n     * a timeline array to the `trials` parameter and/or an array of file paths to the `images`, `audio`, and/or `video`\r\n     * parameters. Setting this parameter to `false` is useful when you plan to preload your files in smaller batches\r\n     * throughout the experiment. */\r\n    auto_preload: {\r\n      type: ParameterType.BOOL,\r\n      default: false,\r\n    },\r\n    /** An array containing one or more jsPsych trial or timeline objects. This parameter is useful when you want to\r\n     * automatically preload stimuli files from a specific subset of the experiment. See [Creating an Experiment:\r\n     * The Timeline](../overview/timeline.md) for information on constructing timelines. */\r\n    trials: {\r\n      type: ParameterType.TIMELINE,\r\n      default: [],\r\n    },\r\n    /**\r\n     * Array with one or more image files to load. This parameter is often used in cases where media files cannot\r\n     * be automatically preloaded based on the timeline, e.g. because the media files are passed into an image plugin/parameter with\r\n     * timeline variables or dynamic parameters, or because the image is embedded in an HTML string.\r\n     */\r\n    images: {\r\n      type: ParameterType.STRING,\r\n      default: [],\r\n      array: true,\r\n    },\r\n    /**\r\n     * Array with one or more audio files to load. This parameter is often used in cases where media files cannot\r\n     * be automatically preloaded based on the timeline, e.g. because the media files are passed into an audio plugin/parameter with\r\n     * timeline variables or dynamic parameters, or because the audio is embedded in an HTML string.\r\n     */\r\n    audio: {\r\n      type: ParameterType.STRING,\r\n      default: [],\r\n      array: true,\r\n    },\r\n    /**\r\n     * Array with one or more video files to load. This parameter is often used in cases where media files cannot\r\n     * be automatically preloaded based on the timeline, e.g. because the media files are passed into a video plugin/parameter with\r\n     * timeline variables or dynamic parameters, or because the video is embedded in an HTML string.\r\n     */\r\n    video: {\r\n      type: ParameterType.STRING,\r\n      default: [],\r\n      array: true,\r\n    },\r\n    /** HTML-formatted message to show above the progress bar while the files are loading. If `null`, then no message is shown. */\r\n    message: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: null,\r\n    },\r\n    /** If `true`, a progress bar will be shown while the files are loading. If `false`, no progress bar is shown. */\r\n    show_progress_bar: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n    /**\r\n     * Whether or not to continue with the experiment if a loading error occurs. If false, then if a loading error occurs,\r\n     * the error_message will be shown on the page and the trial will not end. If true, then if if a loading error occurs, the trial will end\r\n     * and preloading failure will be logged in the trial data.\r\n     */\r\n    continue_after_error: {\r\n      type: ParameterType.BOOL,\r\n      default: false,\r\n    },\r\n    /** HTML-formatted message to be shown on the page after loading fails or times out. Only applies when `continue_after_error` is `false`.*/\r\n    error_message: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: \"The experiment failed to load.\",\r\n    },\r\n    /**\r\n     * Whether or not to show a detailed error message on the page. If true, then detailed error messages will be shown on the\r\n     * page for all files that failed to load, along with the general error_message. This parameter is only relevant when continue_after_error is false.\r\n     */\r\n    show_detailed_errors: {\r\n      type: ParameterType.BOOL,\r\n      default: false,\r\n    },\r\n    /**\r\n     * The maximum amount of time that the plugin should wait before stopping the preload and either ending the trial\r\n     * (if continue_after_error is true) or stopping the experiment with an error message (if continue_after_error is false).\r\n     * If null, the plugin will wait indefintely for the files to load.\r\n     */\r\n    max_load_time: {\r\n      type: ParameterType.INT,\r\n      default: null,\r\n    },\r\n    /** Function to be called after a file fails to load. The function takes the file name as its only argument. */\r\n    on_error: {\r\n      type: ParameterType.FUNCTION,\r\n      default: null,\r\n    },\r\n    /** Function to be called after a file loads successfully. The function takes the file name as its only argument. */\r\n    on_success: {\r\n      type: ParameterType.FUNCTION,\r\n      default: null,\r\n    },\r\n  },\r\n  data: {\r\n    /**  If `true`, then all files loaded successfully within the `max_load_time`. If `false`, then one or\r\n     * more file requests returned a failure and/or the file loading did not complete within the `max_load_time` duration.*/\r\n    success: {\r\n      type: ParameterType.BOOL,\r\n    },\r\n    /** If `true`, then the files did not finish loading within the `max_load_time` duration.\r\n     * If `false`, then the file loading did not timeout. Note that when the preload trial does not timeout\r\n     * (`timeout: false`), it is still possible for loading to fail (`success: false`). This happens if\r\n     * one or more files fails to load and all file requests trigger either a success or failure event before\r\n     * the `max_load_time` duration. */\r\n    timeout: {\r\n      type: ParameterType.BOOL,\r\n    },\r\n    /** One or more image file paths that produced a loading failure before the trial ended. */\r\n    failed_images: {\r\n      type: ParameterType.STRING,\r\n      array: true,\r\n    },\r\n    /** One or more audio file paths that produced a loading failure before the trial ended. */\r\n    failed_audio: {\r\n      type: ParameterType.STRING,\r\n      array: true,\r\n    },\r\n    /** One or more video file paths that produced a loading failure before the trial ended. */\r\n    failed_video: {\r\n      type: ParameterType.STRING,\r\n      array: true,\r\n    },\r\n  },\r\n  // prettier-ignore\r\n  citations: '__CITATIONS__',\r\n};\r\n\r\ntype Info = typeof info;\r\n\r\n/**\r\n * This plugin loads images, audio, and video files. It is used for loading files into the browser's memory before they are\r\n * needed in the experiment, in order to improve stimulus and response timing, and avoid disruption to the experiment flow.\r\n * We recommend using this plugin anytime you are loading media files, and especially when your experiment requires large\r\n * and/or many media files. See the [Media Preloading page](../overview/media-preloading.md) for more information.\r\n *\r\n * The preload trial will end as soon as all files have loaded successfully. The trial will end or stop with an error\r\n * message when one of these two scenarios occurs (whichever comes first): (a) all files have not finished loading\r\n * when the `max_load_time` duration is reached, or (b) all file requests have responded with either a load or fail\r\n * event, and one or more files has failed to load. The `continue_after_error` parameter determines whether the trial\r\n * will stop with an error message or end (allowing the experiment to continue) when preloading is not successful.\r\n *\r\n * @author Becky Gilbert\r\n * @see {@link https://www.jspsych.org/latest/plugins/preload/ preload plugin documentation on jspsych.org}\r\n */\r\nclass PreloadPlugin implements JsPsychPlugin<Info> {\r\n  static info = info;\r\n\r\n  constructor(private jsPsych: JsPsych) {}\r\n\r\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\r\n    var success = null;\r\n    var timeout = false;\r\n    var failed_images = [];\r\n    var failed_audio = [];\r\n    var failed_video = [];\r\n    var detailed_errors = [];\r\n    var in_safe_mode = this.jsPsych.getSafeModeStatus();\r\n\r\n    // create list of media to preload //\r\n\r\n    var images = [];\r\n    var audio = [];\r\n    var video = [];\r\n\r\n    if (trial.auto_preload) {\r\n      var experiment_timeline = this.jsPsych.getTimeline();\r\n      var auto_preload = this.jsPsych.pluginAPI.getAutoPreloadList(experiment_timeline);\r\n      images = images.concat(auto_preload.images);\r\n      audio = audio.concat(auto_preload.audio);\r\n      video = video.concat(auto_preload.video);\r\n    }\r\n\r\n    if (trial.trials.length > 0) {\r\n      var trial_preloads = this.jsPsych.pluginAPI.getAutoPreloadList(trial.trials);\r\n      images = images.concat(trial_preloads.images);\r\n      audio = audio.concat(trial_preloads.audio);\r\n      video = video.concat(trial_preloads.video);\r\n    }\r\n\r\n    images = images.concat(trial.images);\r\n    audio = audio.concat(trial.audio);\r\n    video = video.concat(trial.video);\r\n\r\n    images = this.jsPsych.utils.unique(images.flat());\r\n    audio = this.jsPsych.utils.unique(audio.flat());\r\n    video = this.jsPsych.utils.unique(video.flat());\r\n\r\n    if (in_safe_mode) {\r\n      // don't preload video if in safe mode (experiment is running via file protocol)\r\n      video = [];\r\n    }\r\n\r\n    // render display of message and progress bar\r\n\r\n    var html = \"\";\r\n\r\n    if (trial.message !== null) {\r\n      html += trial.message;\r\n    }\r\n\r\n    if (trial.show_progress_bar) {\r\n      html += `\r\n            <div id='jspsych-loading-progress-bar-container' style='height: 10px; width: 300px; background-color: #ddd; margin: auto;'>\r\n              <div id='jspsych-loading-progress-bar' style='height: 10px; width: 0%; background-color: #777;'></div>\r\n            </div>`;\r\n    }\r\n\r\n    display_element.innerHTML = html;\r\n\r\n    const update_loading_progress_bar = () => {\r\n      loaded++;\r\n      if (trial.show_progress_bar) {\r\n        var percent_loaded = (loaded / total_n) * 100;\r\n        var preload_progress_bar = display_element.querySelector<HTMLElement>(\r\n          \"#jspsych-loading-progress-bar\"\r\n        );\r\n        if (preload_progress_bar !== null) {\r\n          preload_progress_bar.style.width = percent_loaded + \"%\";\r\n        }\r\n      }\r\n    };\r\n\r\n    // called if all files load successfully\r\n    const on_success = () => {\r\n      if (typeof timeout !== \"undefined\" && timeout === false) {\r\n        // clear timeout immediately after finishing, to handle race condition with max_load_time\r\n        this.jsPsych.pluginAPI.clearAllTimeouts();\r\n        // need to call cancel preload function to clear global jsPsych preload_request list, even when they've all succeeded\r\n        this.jsPsych.pluginAPI.cancelPreloads();\r\n        success = true;\r\n        end_trial();\r\n      }\r\n    };\r\n\r\n    // called if all_files haven't finished loading when max_load_time is reached\r\n    const on_timeout = () => {\r\n      this.jsPsych.pluginAPI.cancelPreloads();\r\n      if (typeof success !== \"undefined\" && (success === false || success === null)) {\r\n        timeout = true;\r\n        if (loaded_success < total_n) {\r\n          success = false;\r\n        }\r\n        after_error(\"timeout\"); // call trial's on_error event handler here, in case loading timed out with no file errors\r\n        detailed_errors.push(\r\n          \"<p><strong>Loading timed out.</strong><br>\" +\r\n            \"Consider compressing your stimuli files, loading your files in smaller batches,<br>\" +\r\n            \"and/or increasing the <i>max_load_time</i> parameter.</p>\"\r\n        );\r\n        if (trial.continue_after_error) {\r\n          end_trial();\r\n        } else {\r\n          stop_with_error_message();\r\n        }\r\n      }\r\n    };\r\n\r\n    const stop_with_error_message = () => {\r\n      this.jsPsych.pluginAPI.clearAllTimeouts();\r\n      this.jsPsych.pluginAPI.cancelPreloads();\r\n      // show error message\r\n      display_element.innerHTML = trial.error_message;\r\n      // show detailed errors, if necessary\r\n      if (trial.show_detailed_errors) {\r\n        display_element.innerHTML += \"<p><strong>Error details:</strong></p>\";\r\n        detailed_errors.forEach((e) => {\r\n          display_element.innerHTML += e;\r\n        });\r\n      }\r\n    };\r\n\r\n    const end_trial = () => {\r\n      var trial_data = {\r\n        success: success,\r\n        timeout: timeout,\r\n        failed_images: failed_images,\r\n        failed_audio: failed_audio,\r\n        failed_video: failed_video,\r\n      };\r\n\r\n      this.jsPsych.finishTrial(trial_data);\r\n    };\r\n\r\n    // do preloading\r\n\r\n    if (trial.max_load_time !== null) {\r\n      this.jsPsych.pluginAPI.setTimeout(on_timeout, trial.max_load_time);\r\n    }\r\n\r\n    var total_n = images.length + audio.length + video.length;\r\n    var loaded = 0; // success or error count\r\n    var loaded_success = 0; // success count\r\n\r\n    if (total_n == 0) {\r\n      on_success();\r\n    } else {\r\n      const load_video = (cb) => {\r\n        this.jsPsych.pluginAPI.preloadVideo(video, cb, file_loading_success, file_loading_error);\r\n      };\r\n      const load_audio = (cb) => {\r\n        this.jsPsych.pluginAPI.preloadAudio(audio, cb, file_loading_success, file_loading_error);\r\n      };\r\n      const load_images = (cb) => {\r\n        this.jsPsych.pluginAPI.preloadImages(images, cb, file_loading_success, file_loading_error);\r\n      };\r\n      if (video.length > 0) {\r\n        load_video(() => {});\r\n      }\r\n      if (audio.length > 0) {\r\n        load_audio(() => {});\r\n      }\r\n      if (images.length > 0) {\r\n        load_images(() => {});\r\n      }\r\n    }\r\n\r\n    // helper functions and callbacks\r\n\r\n    // called when a single file loading fails\r\n    function file_loading_error(e) {\r\n      // update progress bar even if there's an error\r\n      update_loading_progress_bar();\r\n      // change success flag after first file loading error\r\n      if (success == null) {\r\n        success = false;\r\n      }\r\n      // add file to failed media list\r\n      var source = \"unknown file\";\r\n      if (e.source) {\r\n        source = e.source;\r\n      }\r\n      if (e.error && e.error.path && e.error.path.length > 0) {\r\n        if (e.error.path[0].localName == \"img\") {\r\n          failed_images.push(source);\r\n        } else if (e.error.path[0].localName == \"audio\") {\r\n          failed_audio.push(source);\r\n        } else if (e.error.path[0].localName == \"video\") {\r\n          failed_video.push(source);\r\n        }\r\n      }\r\n      // construct detailed error message\r\n      var err_msg = \"<p><strong>Error loading file: \" + source + \"</strong><br>\";\r\n      if (e.error.statusText) {\r\n        err_msg += \"File request response status: \" + e.error.statusText + \"<br>\";\r\n      }\r\n      if (e.error == \"404\") {\r\n        err_msg += \"404 - file not found.<br>\";\r\n      }\r\n      if (\r\n        typeof e.error.loaded !== \"undefined\" &&\r\n        e.error.loaded !== null &&\r\n        e.error.loaded !== 0\r\n      ) {\r\n        err_msg += e.error.loaded + \" bytes transferred.\";\r\n      } else {\r\n        err_msg +=\r\n          \"File did not begin loading. Check that file path is correct and reachable by the browser,<br>\" +\r\n          \"and that loading is not blocked by cross-origin resource sharing (CORS) errors.\";\r\n      }\r\n      err_msg += \"</p>\";\r\n      detailed_errors.push(err_msg);\r\n      // call trial's on_error function\r\n      after_error(source);\r\n      // if this is the last file\r\n      if (loaded == total_n) {\r\n        if (trial.continue_after_error) {\r\n          // if continue_after_error is false, then stop with an error\r\n          end_trial();\r\n        } else {\r\n          // otherwise end the trial and continue\r\n          stop_with_error_message();\r\n        }\r\n      }\r\n    }\r\n\r\n    // called when a single file loads successfully\r\n    function file_loading_success(source: string) {\r\n      update_loading_progress_bar();\r\n      // call trial's on_success function\r\n      after_success(source);\r\n      loaded_success++;\r\n      if (loaded_success == total_n) {\r\n        // if this is the last file and all loaded successfully, call success function\r\n        on_success();\r\n      } else if (loaded == total_n) {\r\n        // if this is the last file and there was at least one error\r\n        if (trial.continue_after_error) {\r\n          // end the trial and continue with experiment\r\n          end_trial();\r\n        } else {\r\n          // if continue_after_error is false, then stop with an error\r\n          stop_with_error_message();\r\n        }\r\n      }\r\n    }\r\n\r\n    function after_error(source: string) {\r\n      // call on_error function and pass file name\r\n      if (trial.on_error !== null) {\r\n        trial.on_error(source);\r\n      }\r\n    }\r\n    function after_success(source: string) {\r\n      // call on_success function and pass file name\r\n      if (trial.on_success !== null) {\r\n        trial.on_success(source);\r\n      }\r\n    }\r\n  }\r\n\r\n  simulate(\r\n    trial: TrialType<Info>,\r\n    simulation_mode,\r\n    simulation_options: any,\r\n    load_callback: () => void\r\n  ) {\r\n    if (simulation_mode == \"data-only\") {\r\n      load_callback();\r\n      this.simulate_data_only(trial, simulation_options);\r\n    }\r\n    if (simulation_mode == \"visual\") {\r\n      this.simulate_visual(trial, simulation_options, load_callback);\r\n    }\r\n  }\r\n\r\n  private create_simulation_data(trial: TrialType<Info>, simulation_options) {\r\n    const default_data = {\r\n      success: true,\r\n      timeout: false,\r\n      failed_images: [],\r\n      failed_audio: [],\r\n      failed_video: [],\r\n    };\r\n\r\n    const data = this.jsPsych.pluginAPI.mergeSimulationData(default_data, simulation_options);\r\n\r\n    return data;\r\n  }\r\n\r\n  private simulate_data_only(trial: TrialType<Info>, simulation_options) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    this.jsPsych.finishTrial(data);\r\n  }\r\n\r\n  private simulate_visual(trial: TrialType<Info>, simulation_options, load_callback: () => void) {\r\n    const display_element = this.jsPsych.getDisplayElement();\r\n\r\n    this.trial(display_element, trial);\r\n    load_callback();\r\n  }\r\n}\r\n\r\nexport default PreloadPlugin;\r\n"],"names":["version"],"mappings":"4CAEEA,IAAAA,EAAW,yhCCuIA,UAAA,iuBAAe;;;"}