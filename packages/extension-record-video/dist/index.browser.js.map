{"version":3,"file":"index.browser.js","sources":["../../../node_modules/auto-bind/index.js","../package.json","../src/index.ts"],"sourcesContent":["'use strict';\n\n// Gets all non-builtin properties up the prototype chain\nconst getAllProperties = object => {\n\tconst properties = new Set();\n\n\tdo {\n\t\tfor (const key of Reflect.ownKeys(object)) {\n\t\t\tproperties.add([object, key]);\n\t\t}\n\t} while ((object = Reflect.getPrototypeOf(object)) && object !== Object.prototype);\n\n\treturn properties;\n};\n\nmodule.exports = (self, {include, exclude} = {}) => {\n\tconst filter = key => {\n\t\tconst match = pattern => typeof pattern === 'string' ? key === pattern : pattern.test(key);\n\n\t\tif (include) {\n\t\t\treturn include.some(match);\n\t\t}\n\n\t\tif (exclude) {\n\t\t\treturn !exclude.some(match);\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tfor (const [object, key] of getAllProperties(self.constructor.prototype)) {\n\t\tif (key === 'constructor' || !filter(key)) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst descriptor = Reflect.getOwnPropertyDescriptor(object, key);\n\t\tif (descriptor && typeof descriptor.value === 'function') {\n\t\t\tself[key] = self[key].bind(self);\n\t\t}\n\t}\n\n\treturn self;\n};\n","{\r\n  \"name\": \"@jspsych/extension-record-video\",\r\n  \"version\": \"1.2.0\",\r\n  \"description\": \"jsPsych extension for recording video\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/extension-record-video\"\r\n  },\r\n  \"author\": \"Josh de Leeuw\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/extensions/record-video\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.0.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\"\r\n  }\r\n}\r\n","import autoBind from \"auto-bind\";\r\nimport { JsPsych, JsPsychExtension, JsPsychExtensionInfo, ParameterType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\n/**\r\n * https://www.jspsych.org/latest/extensions/record-video/\r\n */\r\nclass RecordVideoExtension implements JsPsychExtension {\r\n  static info: JsPsychExtensionInfo = {\r\n    name: \"record-video\",\r\n    version: version,\r\n    data: {\r\n      /** [Base 64 encoded](https://developer.mozilla.org/en-US/docs/Glossary/Base64) representation of the video data. */\r\n      record_video_data: {\r\n        type: ParameterType.STRING,\r\n      },\r\n    },\r\n    // prettier-ignore\r\n    citations: '__CITATIONS__',\r\n  };\r\n\r\n  constructor(private jsPsych: JsPsych) {\r\n    autoBind(this);\r\n  }\r\n\r\n  private recordedChunks = [];\r\n  private recorder: MediaRecorder = null;\r\n  private currentTrialData = null;\r\n  private trialComplete = false;\r\n  private onUpdateCallback: () => void = null;\r\n\r\n  // todo: add option to stream data to server with timeslice?\r\n  initialize = async () => {};\r\n\r\n  on_start = (): void => {\r\n    this.recorder = this.jsPsych.pluginAPI.getCameraRecorder();\r\n    this.recordedChunks = [];\r\n    this.trialComplete = false;\r\n    this.currentTrialData = {};\r\n\r\n    if (!this.recorder) {\r\n      console.warn(\r\n        \"The record-video extension is trying to start but the camera is not initialized. Do you need to run the initialize-camera plugin?\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    this.recorder.addEventListener(\"dataavailable\", this.handleOnDataAvailable);\r\n  };\r\n\r\n  on_load = () => {\r\n    this.recorder.start();\r\n  };\r\n\r\n  on_finish = (): Promise<any> => {\r\n    return new Promise((resolve) => {\r\n      this.trialComplete = true;\r\n      this.recorder.stop();\r\n\r\n      if (!this.currentTrialData.record_video_data) {\r\n        this.onUpdateCallback = () => {\r\n          resolve(this.currentTrialData);\r\n        };\r\n      } else {\r\n        resolve(this.currentTrialData);\r\n      }\r\n    });\r\n  };\r\n\r\n  private handleOnDataAvailable(event) {\r\n    if (event.data.size > 0) {\r\n      console.log(\"chunks added\");\r\n      this.recordedChunks.push(event.data);\r\n      if (this.trialComplete) {\r\n        this.updateData();\r\n      }\r\n    }\r\n  }\r\n\r\n  private updateData() {\r\n    const data = new Blob(this.recordedChunks, {\r\n      type: this.recorder.mimeType,\r\n    });\r\n    const reader = new FileReader();\r\n    reader.addEventListener(\"load\", () => {\r\n      const base64 = (reader.result as string).split(\",\")[1];\r\n      this.currentTrialData.record_video_data = base64;\r\n      if (this.onUpdateCallback) {\r\n        this.onUpdateCallback();\r\n      }\r\n    });\r\n    reader.readAsDataURL(data);\r\n  }\r\n}\r\n\r\nexport default RecordVideoExtension;\r\n"],"names":[],"mappings":";;;;;;;CAEA;CACA,MAAM,gBAAgB,GAAG,MAAM,IAAI;CACnC,CAAC,MAAM,UAAU,GAAG,IAAI,GAAG,EAAE,CAAA;;CAE7B,CAAC,GAAG;CACJ,EAAE,KAAK,MAAM,GAAG,IAAI,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;CAC7C,GAAG,UAAU,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC,CAAA;CAChC,GAAA;CACA,EAAE,QAAQ,CAAC,MAAM,GAAG,OAAO,CAAC,cAAc,CAAC,MAAM,CAAC,KAAK,MAAM,KAAK,MAAM,CAAC,SAAS,EAAA;;CAElF,CAAC,OAAO,UAAU,CAAA;CAClB,CAAC,CAAA;;KAED,QAAc,GAAG,CAAC,IAAI,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,GAAG,EAAE,KAAK;CACpD,CAAC,MAAM,MAAM,GAAG,GAAG,IAAI;CACvB,EAAE,MAAM,KAAK,GAAG,OAAO,IAAI,OAAO,OAAO,KAAK,QAAQ,GAAG,GAAG,KAAK,OAAO,GAAG,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;;CAE5F,EAAE,IAAI,OAAO,EAAE;CACf,GAAG,OAAO,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAA;CAC7B,GAAA;;CAEA,EAAE,IAAI,OAAO,EAAE;CACf,GAAG,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAA;CAC9B,GAAA;;CAEA,EAAE,OAAO,IAAI,CAAA;CACb,EAAE,CAAA;;CAEF,CAAC,KAAK,MAAM,CAAC,MAAM,EAAE,GAAG,CAAC,IAAI,gBAAgB,CAAC,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,EAAE;CAC3E,EAAE,IAAI,GAAG,KAAK,aAAa,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE;CAC7C,GAAG,SAAA;CACH,GAAA;;CAEA,EAAE,MAAM,UAAU,GAAG,OAAO,CAAC,wBAAwB,CAAC,MAAM,EAAE,GAAG,CAAC,CAAA;CAClE,EAAE,IAAI,UAAU,IAAI,OAAO,UAAU,CAAC,KAAK,KAAK,UAAU,EAAE;CAC5D,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;CACnC,GAAA;CACA,EAAA;;CAEA,CAAC,OAAO,IAAI,CAAA;CACZ,CAAC,CAAA;;;;CCxCC,IAAW,OAAA,GAAA,OAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;OCiBE,SAAA,EAAA;CAAA;;QAAe;CAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","x_google_ignoreList":[0]}