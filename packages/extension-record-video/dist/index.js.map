{"version":3,"file":"index.js","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/extension-record-video\",\r\n  \"version\": \"1.2.0\",\r\n  \"description\": \"jsPsych extension for recording video\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/extension-record-video\"\r\n  },\r\n  \"author\": \"Josh de Leeuw\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/extensions/record-video\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.0.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\"\r\n  }\r\n}\r\n","import autoBind from \"auto-bind\";\r\nimport { JsPsych, JsPsychExtension, JsPsychExtensionInfo, ParameterType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\n/**\r\n * https://www.jspsych.org/latest/extensions/record-video/\r\n */\r\nclass RecordVideoExtension implements JsPsychExtension {\r\n  static info: JsPsychExtensionInfo = {\r\n    name: \"record-video\",\r\n    version: version,\r\n    data: {\r\n      /** [Base 64 encoded](https://developer.mozilla.org/en-US/docs/Glossary/Base64) representation of the video data. */\r\n      record_video_data: {\r\n        type: ParameterType.STRING,\r\n      },\r\n    },\r\n    // prettier-ignore\r\n    citations: '__CITATIONS__',\r\n  };\r\n\r\n  constructor(private jsPsych: JsPsych) {\r\n    autoBind(this);\r\n  }\r\n\r\n  private recordedChunks = [];\r\n  private recorder: MediaRecorder = null;\r\n  private currentTrialData = null;\r\n  private trialComplete = false;\r\n  private onUpdateCallback: () => void = null;\r\n\r\n  // todo: add option to stream data to server with timeslice?\r\n  initialize = async () => {};\r\n\r\n  on_start = (): void => {\r\n    this.recorder = this.jsPsych.pluginAPI.getCameraRecorder();\r\n    this.recordedChunks = [];\r\n    this.trialComplete = false;\r\n    this.currentTrialData = {};\r\n\r\n    if (!this.recorder) {\r\n      console.warn(\r\n        \"The record-video extension is trying to start but the camera is not initialized. Do you need to run the initialize-camera plugin?\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    this.recorder.addEventListener(\"dataavailable\", this.handleOnDataAvailable);\r\n  };\r\n\r\n  on_load = () => {\r\n    this.recorder.start();\r\n  };\r\n\r\n  on_finish = (): Promise<any> => {\r\n    return new Promise((resolve) => {\r\n      this.trialComplete = true;\r\n      this.recorder.stop();\r\n\r\n      if (!this.currentTrialData.record_video_data) {\r\n        this.onUpdateCallback = () => {\r\n          resolve(this.currentTrialData);\r\n        };\r\n      } else {\r\n        resolve(this.currentTrialData);\r\n      }\r\n    });\r\n  };\r\n\r\n  private handleOnDataAvailable(event) {\r\n    if (event.data.size > 0) {\r\n      console.log(\"chunks added\");\r\n      this.recordedChunks.push(event.data);\r\n      if (this.trialComplete) {\r\n        this.updateData();\r\n      }\r\n    }\r\n  }\r\n\r\n  private updateData() {\r\n    const data = new Blob(this.recordedChunks, {\r\n      type: this.recorder.mimeType,\r\n    });\r\n    const reader = new FileReader();\r\n    reader.addEventListener(\"load\", () => {\r\n      const base64 = (reader.result as string).split(\",\")[1];\r\n      this.currentTrialData.record_video_data = base64;\r\n      if (this.onUpdateCallback) {\r\n        this.onUpdateCallback();\r\n      }\r\n    });\r\n    reader.readAsDataURL(data);\r\n  }\r\n}\r\n\r\nexport default RecordVideoExtension;\r\n"],"names":[],"mappings":";;;AAEE,IAAW,OAAA,GAAA,OAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MCiBE,SAAA,EAAA;AAAA;;OAAe;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}