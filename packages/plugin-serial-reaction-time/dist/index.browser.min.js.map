{"version":3,"file":"index.browser.min.js","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/plugin-serial-reaction-time\",\r\n  \"version\": \"2.1.0\",\r\n  \"description\": \"jsPsych plugin for running a serial reaction time task\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/plugin-serial-reaction-time\"\r\n  },\r\n  \"author\": \"Josh de Leeuw\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/plugins/serial-reaction-time\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.1.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\"\r\n  }\r\n}\r\n","import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\nconst info = <const>{\r\n  name: \"serial-reaction-time\",\r\n  version: version,\r\n  parameters: {\r\n    /** This array represents the grid of boxes shown on the screen. Each inner array represents a single row. The entries in the inner arrays represent the columns. If an entry is `1` then a square will be drawn at that location on the grid. If an entry is `0` then the corresponding location on the grid will be empty. Thus, by mixing `1`s and `0`s it is possible to create many different grid-based arrangements. */\r\n    grid: {\r\n      type: ParameterType.BOOL, // TO DO: BOOL doesn't seem like the right type here. INT? Also, is this always a nested array?\r\n      array: true,\r\n      default: [[1, 1, 1, 1]],\r\n    },\r\n    /** The location of the target. The array should be the [row, column] of the target. */\r\n    target: {\r\n      type: ParameterType.INT,\r\n      array: true,\r\n      default: undefined,\r\n    },\r\n    /** The dimensions of this array must match the dimensions of `grid`. Each entry in this array is the key that should be pressed for that corresponding location in the grid. Entries can be left blank if there is no key associated with that location of the grid.  */\r\n    choices: {\r\n      type: ParameterType.KEYS, // TO DO: always a nested array, so I think ParameterType.KEYS and array: true is ok here?\r\n      array: true,\r\n      default: [[\"3\", \"5\", \"7\", \"9\"]],\r\n    },\r\n    /** The width and height in pixels of each square in the grid. */\r\n    grid_square_size: {\r\n      type: ParameterType.INT,\r\n      default: 100,\r\n    },\r\n    /** The color of the target square. */\r\n    target_color: {\r\n      type: ParameterType.STRING,\r\n      default: \"#999\",\r\n    },\r\n    /** If true, the trial ends after a key press. Feedback is displayed if `show_response_feedback` is true. */\r\n    response_ends_trial: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n    /** The number of milliseconds to display the grid *before* the target changes color. */\r\n    pre_target_duration: {\r\n      type: ParameterType.INT,\r\n      default: 0,\r\n    },\r\n    /** The maximum length of time of the trial, not including feedback. */\r\n    trial_duration: {\r\n      type: ParameterType.INT,\r\n      default: null,\r\n    },\r\n    /** If true, show feedback indicating where the user responded and whether it was correct. */\r\n    show_response_feedback: {\r\n      type: ParameterType.BOOL,\r\n      default: false,\r\n    },\r\n    /** The length of time in milliseconds to show the feedback. */\r\n    feedback_duration: {\r\n      type: ParameterType.INT,\r\n      default: 200,\r\n    },\r\n    /** If a positive number, the target will progressively change color at the start of the trial, with the transition lasting this many milliseconds. */\r\n    fade_duration: {\r\n      type: ParameterType.INT,\r\n      default: null,\r\n    },\r\n    /** This string can contain HTML markup. Any content here will be displayed below the stimulus. The intention is that it can be used to provide a reminder about the action the participant is supposed to take (e.g., which keys to press). */\r\n    prompt: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: null,\r\n      no_function: false,\r\n    },\r\n  },\r\n  data: {\r\n    /** The representation of the grid. This will be encoded as a JSON string when data is saved using\r\n     * the `.json()` or `.csv()` functions.  */\r\n    grid: {\r\n      type: ParameterType.COMPLEX,\r\n      array: true,\r\n    },\r\n    /** The representation of the target location on the grid. This will be encoded\r\n     * as a JSON string when data is saved using the `.json()` or `.csv()` functions */\r\n    target: {\r\n      type: ParameterType.COMPLEX,\r\n      array: true,\r\n    },\r\n    /** Indicates which key the participant pressed. */\r\n    response: {\r\n      type: ParameterType.STRING,\r\n      array: true,\r\n    },\r\n    /** The response time in milliseconds for the participant to make a response. The time is measured from when the second stimulus first appears on the screen until the participant's response. */\r\n    rt: {\r\n      type: ParameterType.INT,\r\n    },\r\n    /** `true` if the participant's response matched the target.  */\r\n    correct: {\r\n      type: ParameterType.BOOL,\r\n    },\r\n  },\r\n  // prettier-ignore\r\n  citations: '__CITATIONS__',\r\n};\r\n\r\ntype Info = typeof info;\r\n\r\n/**\r\n * The serial reaction time plugin implements a generalized version of the SRT task\r\n * [(Nissen & Bullemer, 1987)](https://doi.org/10.1016%2F0010-0285%2887%2990002-8).\r\n * Squares are displayed in a grid-based system on the screen, and one square changes color.\r\n * The participant presses a key that corresponds to the darkened key. Feedback is optionally displayed,\r\n * showing the participant which square the key they pressed matches.\r\n *\r\n * @author Josh de Leeuw\r\n * @see {@link https://www.jspsych.org/latest/plugins/serial-reaction-time/ serial-reaction-time plugin documentation on jspsych.org}\r\n */\r\nclass SerialReactionTimePlugin implements JsPsychPlugin<Info> {\r\n  static info = info;\r\n\r\n  constructor(private jsPsych: JsPsych) {}\r\n\r\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\r\n    // create a flattened version of the choices array\r\n    var flat_choices = trial.choices.flat();\r\n    while (flat_choices.indexOf(\"\") > -1) {\r\n      flat_choices.splice(flat_choices.indexOf(\"\"), 1);\r\n    }\r\n\r\n    var keyboardListener: any;\r\n\r\n    var response = <any>{\r\n      rt: null,\r\n      key: false,\r\n      correct: false,\r\n    };\r\n\r\n    const endTrial = () => {\r\n      // kill keyboard listeners\r\n      this.jsPsych.pluginAPI.cancelKeyboardResponse(keyboardListener);\r\n\r\n      // gather the data to store for the trial\r\n      var trial_data = {\r\n        rt: response.rt,\r\n        response: response.key,\r\n        correct: response.correct,\r\n        grid: trial.grid,\r\n        target: trial.target,\r\n      };\r\n\r\n      // move on to the next trial\r\n      this.jsPsych.finishTrial(trial_data);\r\n    };\r\n\r\n    const showFeedback = () => {\r\n      if (response.rt == null || trial.show_response_feedback == false) {\r\n        endTrial();\r\n      } else {\r\n        var color = response.correct ? \"#0f0\" : \"#f00\";\r\n        display_element.querySelector<HTMLElement>(\r\n          \"#jspsych-serial-reaction-time-stimulus-cell-\" +\r\n            response.responseLoc[0] +\r\n            \"-\" +\r\n            response.responseLoc[1]\r\n        ).style.transition = \"\";\r\n        display_element.querySelector<HTMLElement>(\r\n          \"#jspsych-serial-reaction-time-stimulus-cell-\" +\r\n            response.responseLoc[0] +\r\n            \"-\" +\r\n            response.responseLoc[1]\r\n        ).style.backgroundColor = color;\r\n        this.jsPsych.pluginAPI.setTimeout(endTrial, trial.feedback_duration);\r\n      }\r\n    };\r\n\r\n    // function to handle responses by the subject\r\n    const after_response = (info: { key: string; rt: number }) => {\r\n      // only record first response\r\n      response = response.rt == null ? info : response;\r\n\r\n      // check if the response is correct\r\n      var responseLoc = [];\r\n      for (var i = 0; i < trial.choices.length; i++) {\r\n        for (var j = 0; j < trial.choices[i].length; j++) {\r\n          var t = trial.choices[i][j];\r\n          if (this.jsPsych.pluginAPI.compareKeys(info.key, t)) {\r\n            responseLoc = [i, j];\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      response.responseLoc = responseLoc;\r\n      response.correct = JSON.stringify(responseLoc) == JSON.stringify(trial.target);\r\n\r\n      if (trial.response_ends_trial) {\r\n        if (trial.show_response_feedback) {\r\n          showFeedback();\r\n        } else {\r\n          endTrial();\r\n        }\r\n      }\r\n    };\r\n\r\n    const showTarget = () => {\r\n      if (trial.fade_duration == null) {\r\n        display_element.querySelector<HTMLElement>(\r\n          \"#jspsych-serial-reaction-time-stimulus-cell-\" + trial.target[0] + \"-\" + trial.target[1]\r\n        ).style.backgroundColor = trial.target_color;\r\n      } else {\r\n        display_element.querySelector<HTMLElement>(\r\n          \"#jspsych-serial-reaction-time-stimulus-cell-\" + trial.target[0] + \"-\" + trial.target[1]\r\n        ).style.transition = \"background-color \" + trial.fade_duration;\r\n        display_element.querySelector<HTMLElement>(\r\n          \"#jspsych-serial-reaction-time-stimulus-cell-\" + trial.target[0] + \"-\" + trial.target[1]\r\n        ).style.backgroundColor = trial.target_color;\r\n      }\r\n\r\n      keyboardListener = this.jsPsych.pluginAPI.getKeyboardResponse({\r\n        callback_function: after_response,\r\n        valid_responses: flat_choices,\r\n        allow_held_key: false,\r\n      });\r\n\r\n      if (trial.trial_duration !== null) {\r\n        this.jsPsych.pluginAPI.setTimeout(showFeedback, trial.trial_duration);\r\n      }\r\n    };\r\n\r\n    // display stimulus\r\n    var stimulus = this.stimulus(trial.grid, trial.grid_square_size);\r\n    display_element.innerHTML = stimulus;\r\n\r\n    if (trial.pre_target_duration <= 0) {\r\n      showTarget();\r\n    } else {\r\n      this.jsPsych.pluginAPI.setTimeout(showTarget, trial.pre_target_duration);\r\n    }\r\n\r\n    //show prompt if there is one\r\n    if (trial.prompt !== null) {\r\n      display_element.innerHTML += trial.prompt;\r\n    }\r\n  }\r\n\r\n  stimulus = function (\r\n    grid,\r\n    square_size: number,\r\n    target?: number[],\r\n    target_color?: string,\r\n    labels?\r\n  ) {\r\n    // TO DO: types for nested arrays of numbers/strings?\r\n    var stimulus =\r\n      \"<div id='jspsych-serial-reaction-time-stimulus' style='margin:auto; display: table; table-layout: fixed; border-spacing:\" +\r\n      square_size / 4 +\r\n      \"px'>\";\r\n    for (var i = 0; i < grid.length; i++) {\r\n      stimulus +=\r\n        \"<div class='jspsych-serial-reaction-time-stimulus-row' style='display:table-row;'>\";\r\n      for (var j = 0; j < grid[i].length; j++) {\r\n        stimulus +=\r\n          \"<div class='jspsych-serial-reaction-time-stimulus-cell' id='jspsych-serial-reaction-time-stimulus-cell-\" +\r\n          i +\r\n          \"-\" +\r\n          j +\r\n          \"' \" +\r\n          \"style='width:\" +\r\n          square_size +\r\n          \"px; height:\" +\r\n          square_size +\r\n          \"px; display:table-cell; vertical-align:middle; text-align: center; font-size:\" +\r\n          square_size / 2 +\r\n          \"px;\";\r\n        if (grid[i][j] == 1) {\r\n          stimulus += \"border: 2px solid black;\";\r\n        }\r\n        if (typeof target !== \"undefined\" && target[0] == i && target[1] == j) {\r\n          stimulus += \"background-color: \" + target_color + \";\";\r\n        }\r\n        stimulus += \"'>\";\r\n        if (typeof labels !== \"undefined\" && labels[i][j] !== false) {\r\n          stimulus += labels[i][j];\r\n        }\r\n        stimulus += \"</div>\";\r\n      }\r\n      stimulus += \"</div>\";\r\n    }\r\n    stimulus += \"</div>\";\r\n\r\n    return stimulus;\r\n  };\r\n\r\n  simulate(\r\n    trial: TrialType<Info>,\r\n    simulation_mode,\r\n    simulation_options: any,\r\n    load_callback: () => void\r\n  ) {\r\n    if (simulation_mode == \"data-only\") {\r\n      load_callback();\r\n      this.simulate_data_only(trial, simulation_options);\r\n    }\r\n    if (simulation_mode == \"visual\") {\r\n      this.simulate_visual(trial, simulation_options, load_callback);\r\n    }\r\n  }\r\n\r\n  private create_simulation_data(trial: TrialType<Info>, simulation_options) {\r\n    let key;\r\n    if (this.jsPsych.randomization.sampleBernoulli(0.8) == 1) {\r\n      key = trial.choices[trial.target[0]][trial.target[1]];\r\n    } else {\r\n      // @ts-ignore something wrong with trial.choices type here?\r\n      key = this.jsPsych.pluginAPI.getValidKey(trial.choices);\r\n      while (key == trial.choices[trial.target[0]][trial.target[1]]) {\r\n        // @ts-ignore something wrong with trial.choices type here?\r\n        key = this.jsPsych.pluginAPI.getValidKey(trial.choices);\r\n      }\r\n    }\r\n\r\n    const default_data = {\r\n      grid: trial.grid,\r\n      target: trial.target,\r\n      response: key,\r\n      rt: this.jsPsych.randomization.sampleExGaussian(500, 50, 1 / 150, true),\r\n      correct: key == trial.choices[trial.target[0]][trial.target[1]],\r\n    };\r\n\r\n    const data = this.jsPsych.pluginAPI.mergeSimulationData(default_data, simulation_options);\r\n\r\n    this.jsPsych.pluginAPI.ensureSimulationDataConsistency(trial, data);\r\n\r\n    return data;\r\n  }\r\n\r\n  private simulate_data_only(trial: TrialType<Info>, simulation_options) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    this.jsPsych.finishTrial(data);\r\n  }\r\n\r\n  private simulate_visual(trial: TrialType<Info>, simulation_options, load_callback: () => void) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    const display_element = this.jsPsych.getDisplayElement();\r\n\r\n    this.trial(display_element, trial);\r\n    load_callback();\r\n\r\n    if (data.rt !== null) {\r\n      this.jsPsych.pluginAPI.pressKey(data.response, data.rt);\r\n    }\r\n  }\r\n}\r\n\r\nexport default SerialReactionTimePlugin;\r\n"],"names":["version"],"mappings":"uDAEEA,IAAAA,EAAW,0+BCmGA,UAAA,iuBAAe"}