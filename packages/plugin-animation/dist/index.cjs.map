{"version":3,"file":"index.cjs","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/plugin-animation\",\r\n  \"version\": \"2.1.0\",\r\n  \"description\": \"jsPsych plugin for showing animations and recording keyboard responses\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/plugin-animation\"\r\n  },\r\n  \"author\": \"Josh de Leeuw\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/plugins/animation\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.1.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\"\r\n  }\r\n}\r\n","import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\nconst info = <const>{\r\n  name: \"animation\",\r\n  version: version,\r\n  parameters: {\r\n    /** Each element of the array is a path to an image file. */\r\n    stimuli: {\r\n      type: ParameterType.IMAGE,\r\n      default: undefined,\r\n      array: true,\r\n    },\r\n    /** How long to display each image in milliseconds. */\r\n    frame_time: {\r\n      type: ParameterType.INT,\r\n      default: 250,\r\n    },\r\n    /** If greater than 0, then a gap will be shown between each image in the sequence. This parameter\r\n     * specifies the length of the gap in milliseconds.\r\n     */\r\n    frame_isi: {\r\n      type: ParameterType.INT,\r\n      default: 0,\r\n    },\r\n    /** How many times to show the entire sequence. There will be no gap (other than the gap specified by `frame_isi`)\r\n     * between repetitions. */\r\n    sequence_reps: {\r\n      type: ParameterType.INT,\r\n      default: 1,\r\n    },\r\n    /** This array contains the key(s) that the participant is allowed to press in order to respond to the stimulus.\r\n     * Keys should be specified as characters (e.g., `'a'`, `'q'`, `' '`, `'Enter'`, `'ArrowDown'`) - see\r\n     * [this page](https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key/Key_Values) and\r\n     * [this page (event.key column)](https://www.freecodecamp.org/news/javascript-keycode-list-keypress-event-key-codes/)\r\n     * for more examples. Any key presses that are not listed in the array will be ignored. The default value of `\"ALL_KEYS\"`\r\n     * means that all keys will be accepted as valid responses. Specifying `\"NO_KEYS\"` will mean that no responses are allowed. */\r\n    choices: {\r\n      type: ParameterType.KEYS,\r\n      default: \"ALL_KEYS\",\r\n    },\r\n    /** This string can contain HTML markup. Any content here will be displayed below the stimulus. The intention is that\r\n     * it can be used to provide a reminder about the action the participant is supposed to take (e.g., which key(s) to press). */\r\n    prompt: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: null,\r\n    },\r\n    /**\r\n     * If true, the images will be drawn onto a canvas element. This prevents a blank screen (white flash) between consecutive\r\n     * images in some browsers, like Firefox and Edge. If false, the image will be shown via an img element, as in previous\r\n     * versions of jsPsych.\r\n     */\r\n    render_on_canvas: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n  },\r\n  data: {\r\n    /** An array, where each element is an object that represents a stimulus in the animation sequence. Each object has\r\n     * a `stimulus` property, which is the image that was displayed, and a `time` property, which is the time in ms,\r\n     * measured from when the sequence began, that the stimulus was displayed. The array will be encoded in JSON format\r\n     * when data is saved using either the `.json()` or `.csv()` functions.\r\n     */\r\n    animation_sequence: {\r\n      type: ParameterType.COMPLEX,\r\n      array: true,\r\n      nested: {\r\n        stimulus: {\r\n          type: ParameterType.STRING,\r\n        },\r\n        time: {\r\n          type: ParameterType.INT,\r\n        },\r\n      },\r\n    },\r\n    /** An array, where each element is an object representing a response given by the participant. Each object has a\r\n     * `stimulus` property, indicating which image was displayed when the key was pressed, an `rt` property, indicating\r\n     * the time of the key press relative to the start of the animation, and a `key_press` property, indicating which\r\n     * key was pressed. The array will be encoded in JSON format when data is saved using either the `.json()` or `.csv()`\r\n     * functions.\r\n     */\r\n    response: {\r\n      type: ParameterType.COMPLEX,\r\n      array: true,\r\n      nested: {\r\n        stimulus: {\r\n          type: ParameterType.STRING,\r\n        },\r\n        rt: {\r\n          type: ParameterType.INT,\r\n        },\r\n        key_press: {\r\n          type: ParameterType.STRING,\r\n        },\r\n      },\r\n    },\r\n  },\r\n  // prettier-ignore\r\n  citations: '__CITATIONS__',\r\n};\r\n\r\ntype Info = typeof info;\r\n\r\n/**\r\n * This plugin displays a sequence of images at a fixed frame rate. The sequence can be looped a specified number of times.\r\n * The participant is free to respond at any point during the animation, and the time of the response is recorded.\r\n *\r\n * @author Josh de Leeuw\r\n * @see {@link https://www.jspsych.org/latest/plugins/animation/ animation plugin documentation on jspsych.org}\r\n */\r\nclass AnimationPlugin implements JsPsychPlugin<Info> {\r\n  static info = info;\r\n\r\n  constructor(private jsPsych: JsPsych) {}\r\n\r\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\r\n    var interval_time = trial.frame_time + trial.frame_isi;\r\n    var animate_frame = 0;\r\n    var reps = 0;\r\n    var startTime = performance.now();\r\n    var animation_sequence = [];\r\n    var responses = [];\r\n    var current_stim = \"\";\r\n\r\n    if (trial.render_on_canvas) {\r\n      // first clear the display element (because the render_on_canvas method appends to display_element instead of overwriting it with .innerHTML)\r\n      if (display_element.hasChildNodes()) {\r\n        // can't loop through child list because the list will be modified by .removeChild()\r\n        while (display_element.firstChild) {\r\n          display_element.removeChild(display_element.firstChild);\r\n        }\r\n      }\r\n      var canvas = document.createElement(\"canvas\");\r\n      canvas.id = \"jspsych-animation-image\";\r\n      canvas.style.margin = \"0\";\r\n      canvas.style.padding = \"0\";\r\n      display_element.insertBefore(canvas, null);\r\n      var ctx = canvas.getContext(\"2d\");\r\n    }\r\n\r\n    const endTrial = () => {\r\n      this.jsPsych.pluginAPI.cancelKeyboardResponse(response_listener);\r\n\r\n      var trial_data = {\r\n        animation_sequence: animation_sequence,\r\n        response: responses,\r\n      };\r\n\r\n      this.jsPsych.finishTrial(trial_data);\r\n    };\r\n\r\n    var animate_interval = setInterval(() => {\r\n      var showImage = true;\r\n      if (!trial.render_on_canvas) {\r\n        display_element.innerHTML = \"\"; // clear everything\r\n      }\r\n      animate_frame++;\r\n      if (animate_frame == trial.stimuli.length) {\r\n        animate_frame = 0;\r\n        reps++;\r\n        if (reps >= trial.sequence_reps) {\r\n          endTrial();\r\n          clearInterval(animate_interval);\r\n          showImage = false;\r\n        }\r\n      }\r\n      if (showImage) {\r\n        show_next_frame();\r\n      }\r\n    }, interval_time);\r\n\r\n    const show_next_frame = () => {\r\n      if (trial.render_on_canvas) {\r\n        display_element.querySelector<HTMLElement>(\"#jspsych-animation-image\").style.visibility =\r\n          \"visible\";\r\n        var img = new Image();\r\n        img.src = trial.stimuli[animate_frame];\r\n        canvas.height = img.naturalHeight;\r\n        canvas.width = img.naturalWidth;\r\n        ctx.drawImage(img, 0, 0);\r\n        if (trial.prompt !== null && animate_frame == 0 && reps == 0) {\r\n          display_element.insertAdjacentHTML(\"beforeend\", trial.prompt);\r\n        }\r\n      } else {\r\n        // show image\r\n        display_element.innerHTML =\r\n          '<img src=\"' + trial.stimuli[animate_frame] + '\" id=\"jspsych-animation-image\"></img>';\r\n        if (trial.prompt !== null) {\r\n          display_element.innerHTML += trial.prompt;\r\n        }\r\n      }\r\n      current_stim = trial.stimuli[animate_frame];\r\n\r\n      // record when image was shown\r\n      animation_sequence.push({\r\n        stimulus: trial.stimuli[animate_frame],\r\n        time: Math.round(performance.now() - startTime),\r\n      });\r\n\r\n      if (trial.frame_isi > 0) {\r\n        this.jsPsych.pluginAPI.setTimeout(() => {\r\n          display_element.querySelector<HTMLElement>(\"#jspsych-animation-image\").style.visibility =\r\n            \"hidden\";\r\n          current_stim = \"blank\";\r\n          // record when blank image was shown\r\n          animation_sequence.push({\r\n            stimulus: \"blank\",\r\n            time: Math.round(performance.now() - startTime),\r\n          });\r\n        }, trial.frame_time);\r\n      }\r\n    };\r\n\r\n    var after_response = (info) => {\r\n      responses.push({\r\n        key_press: info.key,\r\n        rt: info.rt,\r\n        stimulus: current_stim,\r\n      });\r\n\r\n      // after a valid response, the stimulus will have the CSS class 'responded'\r\n      // which can be used to provide visual feedback that a response was recorded\r\n      display_element.querySelector(\"#jspsych-animation-image\").className += \" responded\";\r\n    };\r\n\r\n    // hold the jspsych response listener object in memory\r\n    // so that we can turn off the response collection when\r\n    // the trial ends\r\n    var response_listener = this.jsPsych.pluginAPI.getKeyboardResponse({\r\n      callback_function: after_response,\r\n      valid_responses: trial.choices,\r\n      rt_method: \"performance\",\r\n      persist: true,\r\n      allow_held_key: false,\r\n    });\r\n\r\n    // show the first frame immediately\r\n    show_next_frame();\r\n  }\r\n\r\n  simulate(\r\n    trial: TrialType<Info>,\r\n    simulation_mode,\r\n    simulation_options: any,\r\n    load_callback: () => void\r\n  ) {\r\n    if (simulation_mode == \"data-only\") {\r\n      load_callback();\r\n      this.simulate_data_only(trial, simulation_options);\r\n    }\r\n    if (simulation_mode == \"visual\") {\r\n      this.simulate_visual(trial, simulation_options, load_callback);\r\n    }\r\n  }\r\n\r\n  private create_simulation_data(trial: TrialType<Info>, simulation_options) {\r\n    const fake_animation_sequence = [];\r\n    const fake_responses = [];\r\n    let t = 0;\r\n    const check_if_fake_response_generated: () => boolean = () => {\r\n      return this.jsPsych.randomization.sampleWithReplacement([true, false], 1, [1, 10])[0];\r\n    };\r\n    for (let i = 0; i < trial.sequence_reps; i++) {\r\n      for (const frame of trial.stimuli) {\r\n        fake_animation_sequence.push({\r\n          stimulus: frame,\r\n          time: t,\r\n        });\r\n        if (check_if_fake_response_generated()) {\r\n          fake_responses.push({\r\n            key_press: this.jsPsych.pluginAPI.getValidKey(trial.choices),\r\n            rt: t + this.jsPsych.randomization.randomInt(0, trial.frame_time - 1),\r\n            current_stim: frame,\r\n          });\r\n        }\r\n        t += trial.frame_time;\r\n        if (trial.frame_isi > 0) {\r\n          fake_animation_sequence.push({\r\n            stimulus: \"blank\",\r\n            time: t,\r\n          });\r\n          if (check_if_fake_response_generated()) {\r\n            fake_responses.push({\r\n              key_press: this.jsPsych.pluginAPI.getValidKey(trial.choices),\r\n              rt: t + this.jsPsych.randomization.randomInt(0, trial.frame_isi - 1),\r\n              current_stim: \"blank\",\r\n            });\r\n          }\r\n          t += trial.frame_isi;\r\n        }\r\n      }\r\n    }\r\n\r\n    const default_data = {\r\n      animation_sequence: fake_animation_sequence,\r\n      response: fake_responses,\r\n    };\r\n\r\n    const data = this.jsPsych.pluginAPI.mergeSimulationData(default_data, simulation_options);\r\n\r\n    this.jsPsych.pluginAPI.ensureSimulationDataConsistency(trial, data);\r\n\r\n    return data;\r\n  }\r\n\r\n  private simulate_data_only(trial: TrialType<Info>, simulation_options) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    this.jsPsych.finishTrial(data);\r\n  }\r\n\r\n  private simulate_visual(trial: TrialType<Info>, simulation_options, load_callback: () => void) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    const display_element = this.jsPsych.getDisplayElement();\r\n\r\n    this.trial(display_element, trial);\r\n    load_callback();\r\n\r\n    for (const response of data.response) {\r\n      this.jsPsych.pluginAPI.pressKey(response.key_press, response.rt);\r\n    }\r\n  }\r\n}\r\n\r\nexport default AnimationPlugin;\r\n"],"names":[],"mappings":";;;;AAEE,IAAW,OAAA,GAAA,OAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ECiGA,SAAA,EAAA;AAAA;;GAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}