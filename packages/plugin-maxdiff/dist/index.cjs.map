{"version":3,"file":"index.cjs","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/plugin-maxdiff\",\r\n  \"version\": \"2.1.0\",\r\n  \"description\": \"a jspsych plugin for maxdiff/conjoint analysis designs\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/plugin-maxdiff\"\r\n  },\r\n  \"author\": \"Angus Hughes\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/plugins/maxdiff\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.1.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\"\r\n  }\r\n}\r\n","import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\nconst info = <const>{\r\n  name: \"maxdiff\",\r\n  version: version,\r\n  parameters: {\r\n    /** An array of one or more alternatives of string type to fill the rows of the maxdiff table. If `required` is true,\r\n     * then the array must contain two or more alternatives, so that at least one can be selected for both the left\r\n     * and right columns.  */\r\n    alternatives: {\r\n      type: ParameterType.STRING,\r\n      array: true,\r\n      default: undefined,\r\n    },\r\n    /** An array with exactly two labels of string type to display as column headings (to the left and right of the\r\n     * alternatives) for responses on the criteria of interest. */\r\n    labels: {\r\n      type: ParameterType.STRING,\r\n      array: true,\r\n      default: undefined,\r\n    },\r\n    /** If true, the display order of `alternatives` is randomly determined at the start of the trial. */\r\n    randomize_alternative_order: {\r\n      type: ParameterType.BOOL,\r\n      default: false,\r\n    },\r\n    /** HTML formatted string to display at the top of the page above the maxdiff table. */\r\n    preamble: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: \"\",\r\n    },\r\n    /** Label of the button to submit response. */\r\n    button_label: {\r\n      type: ParameterType.STRING,\r\n      default: \"Continue\",\r\n    },\r\n    /** If true, prevents the user from submitting the response and proceeding until a radio button in both the left and right response columns has been selected. */\r\n    required: {\r\n      type: ParameterType.BOOL,\r\n      default: false,\r\n    },\r\n  },\r\n  data: {\r\n    /** The response time in milliseconds for the participant to make a response. The time is measured from when the maxdiff table first\r\n     * appears on the screen until the participant's response. */\r\n    rt: {\r\n      type: ParameterType.INT,\r\n    },\r\n    /** An object with two keys, `left` and `right`, containing the labels (strings) corresponding to the left and right response\r\n     * columns. This will be encoded as a JSON string when data is saved using the `.json()` or `.csv()` functions.  */\r\n    labels: {\r\n      type: ParameterType.COMPLEX,\r\n      nested: {\r\n        left: {\r\n          type: ParameterType.STRING,\r\n        },\r\n        right: {\r\n          type: ParameterType.STRING,\r\n        },\r\n      },\r\n    },\r\n    /** An object with two keys, `left` and `right`, containing the alternatives selected on the left and right columns.\r\n     * This will be encoded as a JSON string when data is saved using the `.json()` or `.csv()` functions. */\r\n    response: {\r\n      type: ParameterType.COMPLEX,\r\n      nested: {\r\n        left: {\r\n          type: ParameterType.STRING,\r\n        },\r\n        right: {\r\n          type: ParameterType.STRING,\r\n        },\r\n      },\r\n    },\r\n  },\r\n  // prettier-ignore\r\n  citations: '__CITATIONS__',\r\n};\r\n\r\ntype Info = typeof info;\r\n\r\n/**\r\n * The maxdiff plugin displays a table with rows of alternatives to be selected for two mutually-exclusive categories,\r\n * typically as 'most' or 'least' on a particular criteria (e.g. importance, preference, similarity). The participant\r\n * responds by selecting one radio button corresponding to an alternative in both the left and right response columns.\r\n * The same alternative cannot be endorsed on both the left and right response columns (e.g. 'most' and 'least') simultaneously.\r\n *\r\n * @author Angus Hughes\r\n * @see {@link https://www.jspsych.org/latest/plugins/maxdiff/ maxdiff plugin documentation on jspsych.org}\r\n */\r\nclass MaxdiffPlugin implements JsPsychPlugin<Info> {\r\n  static info = info;\r\n\r\n  constructor(private jsPsych: JsPsych) {}\r\n\r\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\r\n    var html = \"\";\r\n    // inject CSS for trial\r\n    html += '<style id=\"jspsych-maxdiff-css\">';\r\n    html +=\r\n      \".jspsych-maxdiff-statement {display:block; font-size: 16px; padding-top: 40px; margin-bottom:10px;}\" +\r\n      \"table.jspsych-maxdiff-table {border-collapse: collapse; padding: 15px; margin-left: auto; margin-right: auto;}\" +\r\n      \"table.jspsych-maxdiff-table td, th {border-bottom: 1px solid #dddddd; text-align: center; padding: 8px;}\" +\r\n      \"table.jspsych-maxdiff-table tr:nth-child(even) {background-color: #dddddd;}\";\r\n    html += \"</style>\";\r\n\r\n    // show preamble text\r\n    if (trial.preamble !== null) {\r\n      html +=\r\n        '<div id=\"jspsych-maxdiff-preamble\" class=\"jspsych-maxdiff-preamble\">' +\r\n        trial.preamble +\r\n        \"</div>\";\r\n    }\r\n    html += '<form id=\"jspsych-maxdiff-form\">';\r\n\r\n    // add maxdiff options ///\r\n    // first generate alternative order, randomized here as opposed to randomizing the order of alternatives\r\n    // so that the data are always associated with the same alternative regardless of order.\r\n    var alternative_order = [];\r\n    for (var i = 0; i < trial.alternatives.length; i++) {\r\n      alternative_order.push(i);\r\n    }\r\n    if (trial.randomize_alternative_order) {\r\n      alternative_order = this.jsPsych.randomization.shuffle(alternative_order);\r\n    }\r\n\r\n    // Start with column headings\r\n    var maxdiff_table =\r\n      '<table class=\"jspsych-maxdiff-table\"><tr><th id=\"jspsych-maxdiff-left-label\">' +\r\n      trial.labels[0] +\r\n      '</th><th></th><th id=\"jspsych-maxdiff-right-label\">' +\r\n      trial.labels[1] +\r\n      \"</th></tr>\";\r\n\r\n    // construct each row of the maxdiff table\r\n    for (var i = 0; i < trial.alternatives.length; i++) {\r\n      var alternative = trial.alternatives[alternative_order[i]];\r\n      // add alternative\r\n      maxdiff_table +=\r\n        '<tr><td><input class= \"jspsych-maxdiff-alt-' +\r\n        i.toString() +\r\n        '\" type=\"radio\" name=\"left\" data-name = ' +\r\n        alternative_order[i].toString() +\r\n        \" /><br></td>\";\r\n      maxdiff_table +=\r\n        '<td id=\"jspsych-maxdiff-alternative-' + i.toString() + '\">' + alternative + \"</td>\";\r\n      maxdiff_table +=\r\n        '<td><input class= \"jspsych-maxdiff-alt-' +\r\n        i.toString() +\r\n        '\" type=\"radio\" name=\"right\" data-name = ' +\r\n        alternative_order[i].toString() +\r\n        \" /><br></td></tr>\";\r\n    }\r\n    maxdiff_table += \"</table><br><br>\";\r\n    html += maxdiff_table;\r\n\r\n    // add submit button\r\n    var enable_submit = trial.required == true ? 'disabled = \"disabled\"' : \"\";\r\n    html +=\r\n      '<input type=\"submit\" id=\"jspsych-maxdiff-next\" class=\"jspsych-maxdiff jspsych-btn\" ' +\r\n      enable_submit +\r\n      ' value=\"' +\r\n      trial.button_label +\r\n      '\"></input>';\r\n    html += \"</form>\";\r\n\r\n    display_element.innerHTML = html;\r\n\r\n    // function to control responses\r\n    // first checks that the same alternative cannot be endorsed in the left and right columns simultaneously.\r\n    // then enables the submit button if the trial is required.\r\n    const left_right = [\"left\", \"right\"];\r\n    left_right.forEach((p) => {\r\n      // Get all elements either 'left' or 'right'\r\n      document.getElementsByName(p).forEach((alt) => {\r\n        alt.addEventListener(\"click\", () => {\r\n          // Find the opposite (if left, then right & vice versa) identified by the class (jspsych-maxdiff-alt-1, 2, etc)\r\n          var op = alt[\"name\"] == \"left\" ? \"right\" : \"left\";\r\n          var n = document.getElementsByClassName(alt.className).namedItem(op);\r\n          // If it's checked, uncheck it.\r\n          if (n[\"checked\"]) {\r\n            n[\"checked\"] = false;\r\n          }\r\n\r\n          // check response\r\n          if (trial.required) {\r\n            // Now check if one of both left and right have been enabled to allow submission\r\n            var left_checked = Array.prototype.slice\r\n              .call(document.getElementsByName(\"left\"))\r\n              .some((c: HTMLInputElement) => c.checked);\r\n            var right_checked = Array.prototype.slice\r\n              .call(document.getElementsByName(\"right\"))\r\n              .some((c: HTMLInputElement) => c.checked);\r\n            if (left_checked && right_checked) {\r\n              (document.getElementById(\"jspsych-maxdiff-next\") as HTMLInputElement).disabled =\r\n                false;\r\n            } else {\r\n              (document.getElementById(\"jspsych-maxdiff-next\") as HTMLInputElement).disabled = true;\r\n            }\r\n          }\r\n        });\r\n      });\r\n    });\r\n\r\n    // Get the data once the submit button is clicked\r\n    // Get the data once the submit button is clicked\r\n    display_element.querySelector(\"#jspsych-maxdiff-form\").addEventListener(\"submit\", (e) => {\r\n      e.preventDefault();\r\n\r\n      // measure response time\r\n      var endTime = performance.now();\r\n      var response_time = Math.round(endTime - startTime);\r\n\r\n      // get the alternative by the data-name attribute, allowing a null response if unchecked\r\n      function get_response(side) {\r\n        var col = display_element.querySelectorAll('[name=\"' + side + '\"]:checked')[0];\r\n        if (col === undefined) {\r\n          return null;\r\n        } else {\r\n          var i = parseInt(col.getAttribute(\"data-name\"));\r\n          return trial.alternatives[i];\r\n        }\r\n      }\r\n\r\n      // data saving\r\n      var trial_data = {\r\n        rt: response_time,\r\n        labels: { left: trial.labels[0], right: trial.labels[1] },\r\n        response: { left: get_response(\"left\"), right: get_response(\"right\") },\r\n      };\r\n\r\n      // next trial\r\n      this.jsPsych.finishTrial(trial_data);\r\n    });\r\n\r\n    var startTime = performance.now();\r\n  }\r\n\r\n  simulate(\r\n    trial: TrialType<Info>,\r\n    simulation_mode,\r\n    simulation_options: any,\r\n    load_callback: () => void\r\n  ) {\r\n    if (simulation_mode == \"data-only\") {\r\n      load_callback();\r\n      this.simulate_data_only(trial, simulation_options);\r\n    }\r\n    if (simulation_mode == \"visual\") {\r\n      this.simulate_visual(trial, simulation_options, load_callback);\r\n    }\r\n  }\r\n\r\n  private create_simulation_data(trial: TrialType<Info>, simulation_options) {\r\n    const choices = this.jsPsych.randomization.sampleWithoutReplacement(trial.alternatives, 2);\r\n    const response = { left: null, right: null };\r\n    if (!trial.required && this.jsPsych.randomization.sampleBernoulli(0.1)) {\r\n      choices.pop();\r\n      if (this.jsPsych.randomization.sampleBernoulli(0.8)) {\r\n        choices.pop();\r\n      }\r\n    }\r\n\r\n    if (choices.length == 1) {\r\n      if (this.jsPsych.randomization.sampleBernoulli(0.5)) {\r\n        response.left = choices[0];\r\n      } else {\r\n        response.right = choices[0];\r\n      }\r\n    }\r\n\r\n    if (choices.length == 2) {\r\n      response.left = choices[0];\r\n      response.right = choices[1];\r\n    }\r\n\r\n    const default_data = {\r\n      rt: this.jsPsych.randomization.sampleExGaussian(3000, 300, 1 / 300, true),\r\n      labels: trial.labels,\r\n      response: response,\r\n    };\r\n\r\n    const data = this.jsPsych.pluginAPI.mergeSimulationData(default_data, simulation_options);\r\n\r\n    this.jsPsych.pluginAPI.ensureSimulationDataConsistency(trial, data);\r\n\r\n    return data;\r\n  }\r\n\r\n  private simulate_data_only(trial: TrialType<Info>, simulation_options) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    this.jsPsych.finishTrial(data);\r\n  }\r\n\r\n  private simulate_visual(trial: TrialType<Info>, simulation_options, load_callback: () => void) {\r\n    const data = this.create_simulation_data(trial, simulation_options);\r\n\r\n    const display_element = this.jsPsych.getDisplayElement();\r\n\r\n    this.trial(display_element, trial);\r\n    load_callback();\r\n\r\n    //@ts-ignore something about symbol iterators?\r\n    const list = [...display_element.querySelectorAll(\"[id^=jspsych-maxdiff-alternative]\")].map(\r\n      (x) => {\r\n        return x.innerHTML;\r\n      }\r\n    );\r\n\r\n    if (data.response.left !== null) {\r\n      const index_left = list.indexOf(data.response.left);\r\n      this.jsPsych.pluginAPI.clickTarget(\r\n        display_element.querySelector(`.jspsych-maxdiff-alt-${index_left}[name=\"left\"]`),\r\n        data.rt / 3\r\n      );\r\n    }\r\n\r\n    if (data.response.right !== null) {\r\n      const index_right = list.indexOf(data.response.right);\r\n      this.jsPsych.pluginAPI.clickTarget(\r\n        display_element.querySelector(`.jspsych-maxdiff-alt-${index_right}[name=\"right\"]`),\r\n        (data.rt / 3) * 2\r\n      );\r\n    }\r\n\r\n    this.jsPsych.pluginAPI.clickTarget(\r\n      display_element.querySelector(\"#jspsych-maxdiff-next\"),\r\n      data.rt\r\n    );\r\n  }\r\n}\r\n\r\nexport default MaxdiffPlugin;\r\n"],"names":[],"mappings":";;;;AAEE,IAAW,OAAA,GAAA,OAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EC4EA,SAAA,EAAA;AAAA;;GAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}