{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["import { setImmediate as flushMicroTasks } from \"timers\";\r\n\r\nimport { JsPsych } from \"jspsych\";\r\n\r\n/**\r\n * https://github.com/facebook/jest/issues/2157#issuecomment-279171856\r\n */\r\nexport function flushPromises() {\r\n  return new Promise((resolve) => flushMicroTasks(resolve));\r\n}\r\n\r\nexport function dispatchEvent(event: Event, target: Element = document.body) {\r\n  target.dispatchEvent(event);\r\n  return flushPromises();\r\n}\r\n\r\nexport async function keyDown(key: string) {\r\n  await dispatchEvent(new KeyboardEvent(\"keydown\", { key }));\r\n}\r\n\r\nexport async function keyUp(key: string) {\r\n  await dispatchEvent(new KeyboardEvent(\"keyup\", { key }));\r\n}\r\n\r\nexport async function pressKey(key: string) {\r\n  await keyDown(key);\r\n  await keyUp(key);\r\n}\r\n\r\nexport async function mouseDownMouseUpTarget(target: Element) {\r\n  await dispatchEvent(new MouseEvent(\"mousedown\", { bubbles: true }), target);\r\n  await dispatchEvent(new MouseEvent(\"mouseup\", { bubbles: true }), target);\r\n}\r\n\r\nexport async function clickTarget(target: Element) {\r\n  // Check if the target is a form element and if it's disabled\r\n  if (target instanceof HTMLButtonElement || target instanceof HTMLInputElement) {\r\n    if (target.disabled) {\r\n      console.log(\"Target is disabled, not dispatching click event.\");\r\n      return; // Exit the function if the target is disabled\r\n    }\r\n  }\r\n  await dispatchEvent(new MouseEvent(\"click\", { bubbles: true }), target);\r\n}\r\n\r\n/**\r\n * Dispatch a `MouseEvent` of type `eventType`, with x and y defined relative to the container element.\r\n * @param x The x location of the event, relative to the x location of `container`.\r\n * @param y The y location of the event, relative to the y location of `container`.\r\n * @param container The DOM element for relative location of the event.\r\n */\r\nasync function dispatchMouseEvent(eventType: string, x: number, y: number, container: Element) {\r\n  const containerRect = container.getBoundingClientRect();\r\n  await dispatchEvent(\r\n    new MouseEvent(eventType, {\r\n      clientX: containerRect.x + x,\r\n      clientY: containerRect.y + y,\r\n      bubbles: true,\r\n    }),\r\n    container\r\n  );\r\n}\r\n\r\n/**\r\n * Dispatch a `mousemove` event, with x and y defined relative to the container element.\r\n * @param x The x location of the event, relative to the x location of `container`.\r\n * @param y The y location of the event, relative to the y location of `container`.\r\n * @param container The DOM element for relative location of the event.\r\n */\r\nexport async function mouseMove(x: number, y: number, container: Element) {\r\n  await dispatchMouseEvent(\"mousemove\", x, y, container);\r\n}\r\n\r\n/**\r\n * Dispatch a `mouseup` event, with x and y defined relative to the container element.\r\n * @param x The x location of the event, relative to the x location of `container`.\r\n * @param y The y location of the event, relative to the y location of `container`.\r\n * @param container The DOM element for relative location of the event.\r\n */\r\nexport async function mouseUp(x: number, y: number, container: Element) {\r\n  await dispatchMouseEvent(\"mouseup\", x, y, container);\r\n}\r\n\r\n/**\r\n * Dispatch a `mousemove` event, with x and y defined relative to the container element.\r\n * @param x The x location of the event, relative to the x location of `container`.\r\n * @param y The y location of the event, relative to the y location of `container`.\r\n * @param container The DOM element for relative location of the event.\r\n */\r\nexport async function mouseDown(x: number, y: number, container: Element) {\r\n  await dispatchMouseEvent(\"mousedown\", x, y, container);\r\n}\r\n\r\n/**\r\n * Runs the given timeline by calling `jsPsych.run()` on the provided JsPsych object.\r\n *\r\n * @param timeline The timeline that is passed to `jsPsych.run()`\r\n * @param jsPsych The jsPsych instance to be used. If left empty, a new instance will be created. If\r\n * a settings object is passed instead, the settings will be used to create the jsPsych instance.\r\n *\r\n * @returns An object containing test helper functions, the jsPsych instance, and the jsPsych\r\n * display element\r\n */\r\nexport async function startTimeline(timeline: any[], jsPsych: JsPsych | any = {}) {\r\n  const jsPsychInstance = jsPsych instanceof JsPsych ? jsPsych : new JsPsych(jsPsych);\r\n\r\n  let hasFinished = false;\r\n  const finished = jsPsychInstance.run(timeline).then(() => {\r\n    hasFinished = true;\r\n  });\r\n  await flushPromises();\r\n\r\n  const displayElement = jsPsychInstance.getDisplayElement();\r\n\r\n  return {\r\n    jsPsych: jsPsychInstance,\r\n    displayElement,\r\n    /** Shorthand for `jsPsych.getDisplayElement().innerHTML` */\r\n    getHTML: () => displayElement.innerHTML,\r\n    /** Shorthand for `jsPsych.data.get()` */\r\n    getData: () => jsPsychInstance.data.get(),\r\n    expectFinished: async () => {\r\n      await flushPromises();\r\n      expect(hasFinished).toBe(true);\r\n    },\r\n    expectRunning: async () => {\r\n      await flushPromises();\r\n      expect(hasFinished).toBe(false);\r\n    },\r\n    /** A promise that is resolved when `jsPsych.run()` is done. */\r\n    finished,\r\n  };\r\n}\r\n\r\n/**\r\n * Runs the given timeline by calling `jsPsych.simulate()` on the provided JsPsych object.\r\n *\r\n * @param timeline The timeline that is passed to `jsPsych.run()`\r\n * @param simulation_mode Either 'data-only' mode or 'visual' mode.\r\n * @param simulation_options Options to pass to `jsPsych.simulate()`\r\n * @param jsPsych The jsPsych instance to be used. If left empty, a new instance will be created. If\r\n * a settings object is passed instead, the settings will be used to create the jsPsych instance.\r\n *\r\n * @returns An object containing test helper functions, the jsPsych instance, and the jsPsych\r\n * display element\r\n */\r\nexport async function simulateTimeline(\r\n  timeline: any[],\r\n  simulation_mode?: \"data-only\" | \"visual\",\r\n  simulation_options: any = {},\r\n  jsPsych: JsPsych | any = {}\r\n) {\r\n  const jsPsychInstance = jsPsych instanceof JsPsych ? jsPsych : new JsPsych(jsPsych);\r\n\r\n  let hasFinished = false;\r\n  const finished = jsPsychInstance\r\n    .simulate(timeline, simulation_mode, simulation_options)\r\n    .then(() => {\r\n      hasFinished = true;\r\n    });\r\n  await flushPromises();\r\n\r\n  const displayElement = jsPsychInstance.getDisplayElement();\r\n\r\n  return {\r\n    jsPsych: jsPsychInstance,\r\n    displayElement,\r\n    /** Shorthand for `jsPsych.getDisplayElement().innerHTML` */\r\n    getHTML: () => displayElement.innerHTML,\r\n    /** Shorthand for `jsPsych.data.get()` */\r\n    getData: () => jsPsychInstance.data.get(),\r\n    expectFinished: async () => {\r\n      await flushPromises();\r\n      expect(hasFinished).toBe(true);\r\n    },\r\n    expectRunning: async () => {\r\n      await flushPromises();\r\n      expect(hasFinished).toBe(false);\r\n    },\r\n    /** A promise that is resolved when `jsPsych.simulate()` is done. */\r\n    finished,\r\n  };\r\n}\r\n"],"names":["flushMicroTasks","JsPsych"],"mappings":"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"}