{"version":3,"file":"index.browser.js","sources":["../package.json","../src/index.ts"],"sourcesContent":["{\r\n  \"name\": \"@jspsych/plugin-sketchpad\",\r\n  \"version\": \"2.1.0\",\r\n  \"description\": \"jsPsych plugin for sketching a response\",\r\n  \"type\": \"module\",\r\n  \"main\": \"dist/index.cjs\",\r\n  \"exports\": {\r\n    \"import\": \"./dist/index.js\",\r\n    \"require\": \"./dist/index.cjs\"\r\n  },\r\n  \"typings\": \"dist/index.d.ts\",\r\n  \"unpkg\": \"dist/index.browser.min.js\",\r\n  \"files\": [\r\n    \"src\",\r\n    \"dist\"\r\n  ],\r\n  \"source\": \"src/index.ts\",\r\n  \"scripts\": {\r\n    \"test\": \"jest\",\r\n    \"test:watch\": \"npm test -- --watch\",\r\n    \"tsc\": \"tsc\",\r\n    \"build\": \"rollup --config\",\r\n    \"build:watch\": \"npm run build -- --watch\"\r\n  },\r\n  \"repository\": {\r\n    \"type\": \"git\",\r\n    \"url\": \"git+https://github.com/jspsych/jsPsych.git\",\r\n    \"directory\": \"packages/plugin-sketchpad\"\r\n  },\r\n  \"author\": \"Josh de Leeuw\",\r\n  \"license\": \"MIT\",\r\n  \"bugs\": {\r\n    \"url\": \"https://github.com/jspsych/jsPsych/issues\"\r\n  },\r\n  \"homepage\": \"https://www.jspsych.org/latest/plugins/sketchpad\",\r\n  \"peerDependencies\": {\r\n    \"jspsych\": \">=7.1.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@jspsych/config\": \"^3.2.0\",\r\n    \"@jspsych/test-utils\": \"^1.2.0\" \r\n  }\r\n}\r\n","import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\r\n\r\nimport { version } from \"../package.json\";\r\n\r\nconst info = <const>{\r\n  name: \"sketchpad\",\r\n  version: version,\r\n  parameters: {\r\n    /**\r\n     * The shape of the canvas element. Accepts `'rectangle'` or `'circle'`\r\n     */\r\n    canvas_shape: {\r\n      type: ParameterType.STRING,\r\n      default: \"rectangle\",\r\n    },\r\n    /**\r\n     * Width of the canvas in pixels when `canvas_shape` is a `\"rectangle\"`.\r\n     */\r\n    canvas_width: {\r\n      type: ParameterType.INT,\r\n      default: 500,\r\n    },\r\n    /**\r\n     * Height of the canvas in pixels when `canvas_shape` is a `\"rectangle\"`.\r\n     */\r\n    canvas_height: {\r\n      type: ParameterType.INT,\r\n      default: 500,\r\n    },\r\n    /**\r\n     * Diameter of the canvas (when `canvas_shape` is `'circle'`) in pixels.\r\n     */\r\n    canvas_diameter: {\r\n      type: ParameterType.INT,\r\n      default: 500,\r\n    },\r\n    /**\r\n     * This width of the border around the canvas element\r\n     */\r\n    canvas_border_width: {\r\n      type: ParameterType.INT,\r\n      default: 0,\r\n    },\r\n    /**\r\n     * The color of the border around the canvas element.\r\n     */\r\n    canvas_border_color: {\r\n      type: ParameterType.STRING,\r\n      default: \"#000\",\r\n    },\r\n    /**\r\n     * Path to an image to render as the background of the canvas.\r\n     */\r\n    background_image: {\r\n      type: ParameterType.IMAGE,\r\n      default: null,\r\n    },\r\n    /**\r\n     * Color of the canvas background. Note that a `background_image` will render on top of the color.\r\n     */\r\n    background_color: {\r\n      type: ParameterType.STRING,\r\n      default: \"#ffffff\",\r\n    },\r\n    /**\r\n     * The width of the strokes on the canvas.\r\n     */\r\n    stroke_width: {\r\n      type: ParameterType.INT,\r\n      default: 2,\r\n    },\r\n    /**\r\n     * The color of the stroke on the canvas.\r\n     */\r\n    stroke_color: {\r\n      type: ParameterType.STRING,\r\n      default: \"#000000\",\r\n    },\r\n    /**\r\n     * Array of colors to render as a palette of choices for stroke color. Clicking on the corresponding color button will change the stroke color.\r\n     */\r\n    stroke_color_palette: {\r\n      type: ParameterType.STRING,\r\n      array: true,\r\n      default: [],\r\n    },\r\n    /**\r\n     * HTML content to render above or below the canvas (use `prompt_location` parameter to change location).\r\n     */\r\n    prompt: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: null,\r\n    },\r\n    /**\r\n     * Location of the `prompt` content. Can be 'abovecanvas' or 'belowcanvas' or 'belowbutton'.\r\n     */\r\n    prompt_location: {\r\n      type: ParameterType.STRING,\r\n      default: \"abovecanvas\",\r\n    },\r\n    /**\r\n     * Whether to save the final image in the data as a base64 encoded data URL.\r\n     */\r\n    save_final_image: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n    /**\r\n     * Whether to save the individual stroke data that generated the final image.\r\n     */\r\n    save_strokes: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n    /**\r\n     * If this key is held down then it is like the mouse button being held down.\r\n     * The \"ink\" will flow when the button is held and stop when it is lifted.\r\n     * Pass in the string representation of the key, e.g., `'a'` for the A key\r\n     * or `' '` for the spacebar.\r\n     */\r\n    key_to_draw: {\r\n      type: ParameterType.KEY,\r\n      default: null,\r\n    },\r\n    /**\r\n     * Whether to show the button that ends the trial.\r\n     */\r\n    show_finished_button: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n    /**\r\n     * The label for the button that ends the trial.\r\n     */\r\n    finished_button_label: {\r\n      type: ParameterType.STRING,\r\n      default: \"Finished\",\r\n    },\r\n    /**\r\n     * Whether to show the button that clears the entire drawing.\r\n     */\r\n    show_clear_button: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n    /**\r\n     * The label for the button that clears the entire drawing.\r\n     */\r\n    clear_button_label: {\r\n      type: ParameterType.STRING,\r\n      default: \"Clear\",\r\n    },\r\n    /**\r\n     * Whether to show the button that enables an undo action.\r\n     */\r\n    show_undo_button: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n    /**\r\n     * The label for the button that performs an undo action.\r\n     */\r\n    undo_button_label: {\r\n      type: ParameterType.STRING,\r\n      default: \"Undo\",\r\n    },\r\n    /**\r\n     * Whether to show the button that enables an redo action. `show_undo_button` must also\r\n     * be `true` for the redo button to show.\r\n     */\r\n    show_redo_button: {\r\n      type: ParameterType.BOOL,\r\n      default: true,\r\n    },\r\n    /**\r\n     * The label for the button that performs an redo action.\r\n     */\r\n    redo_button_label: {\r\n      type: ParameterType.STRING,\r\n      default: \"Redo\",\r\n    },\r\n    /**\r\n     * This array contains the key(s) that the participant is allowed to press in order to end\r\n     * the trial. Keys should be specified as characters (e.g., `'a'`, `'q'`, `' '`, `'Enter'`,\r\n     * `'ArrowDown'`) - see [this page](https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key/Key_Values)\r\n     * and [this page (event.key column)](https://www.freecodecamp.org/news/javascript-keycode-list-keypress-event-key-codes/)\r\n     * for more examples. Any key presses that are not listed in the array will be ignored. The default value of `\"NO_KEYS\"`\r\n     * means that no keys will be accepted as valid responses. Specifying `\"ALL_KEYS\"` will mean that all responses are allowed.\r\n     */\r\n    choices: {\r\n      type: ParameterType.KEYS,\r\n      default: \"NO_KEYS\",\r\n    },\r\n    /**\r\n     * Length of time before the trial ends. If `null` the trial will continue indefinitely\r\n     * (until another way of ending the trial occurs).\r\n     */\r\n    trial_duration: {\r\n      type: ParameterType.INT,\r\n      default: null,\r\n    },\r\n    /**\r\n     * Whether to show a timer that counts down until the end of the trial when `trial_duration` is not `null`.\r\n     */\r\n    show_countdown_trial_duration: {\r\n      type: ParameterType.BOOL,\r\n      default: false,\r\n    },\r\n    /**\r\n     * The HTML to use for rendering the countdown timer. The element with `id=\"sketchpad-timer\"`\r\n     * will have its content replaced by a countdown timer in the format `MM:SS`.\r\n     */\r\n    countdown_timer_html: {\r\n      type: ParameterType.HTML_STRING,\r\n      default: `<span id=\"sketchpad-timer\"></span> remaining`,\r\n    },\r\n  },\r\n  data: {\r\n    /** The length of time from the start of the trial to the end of the trial. */\r\n    rt: {\r\n      type: ParameterType.INT,\r\n    },\r\n    /** If the trial was ended by clicking the finished button, then `\"button\"`. If the trial was ended by pressing a key, then the key that was pressed. If the trial timed out, then `null`. */\r\n    response: {\r\n      type: ParameterType.STRING,\r\n    },\r\n    /** If `save_final_image` is true, then this will contain the base64 encoded data URL for the image, in png format. */\r\n    png: {\r\n      type: ParameterType.STRING,\r\n    },\r\n    /** If `save_strokes` is true, then this will contain an array of stroke objects. Objects have an `action` property that is either `\"start\"`, `\"move\"`, or `\"end\"`. If `action` is `\"start\"` or `\"move\"` it will have an `x` and `y` property that report the coordinates of the action relative to the upper-left corner of the canvas. If `action` is `\"start\"` then the object will also have a `t` and `color` property, specifying the time of the action relative to the onset of the trial (ms) and the color of the stroke. If `action` is `\"end\"` then it will only have a `t` property. */\r\n    strokes: {\r\n      type: ParameterType.COMPLEX,\r\n      array: true,\r\n      nested: {\r\n        action: {\r\n          type: ParameterType.STRING,\r\n        },\r\n        x: {\r\n          type: ParameterType.INT,\r\n          optional: true,\r\n        },\r\n        y: {\r\n          type: ParameterType.INT,\r\n          optional: true,\r\n        },\r\n        t: {\r\n          type: ParameterType.INT,\r\n          optional: true,\r\n        },\r\n        color: {\r\n          type: ParameterType.STRING,\r\n          optional: true,\r\n        },\r\n      },\r\n    },\r\n  },\r\n  // prettier-ignore\r\n  citations: '__CITATIONS__',\r\n};\r\n\r\ntype Info = typeof info;\r\n\r\n/**\r\n * This plugin creates an interactive canvas that the participant can draw on using their mouse or touchscreen.\r\n * It can be used for sketching tasks, like asking the participant to draw a particular object.\r\n * It can also be used for some image segmentation or annotation tasks by setting the `background_image` parameter to render an image on the canvas.\r\n *\r\n * The plugin stores a [base 64 data URL representation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs) of the final image.\r\n * This can be converted to an image file using [online tools](https://www.google.com/search?q=base64+image+decoder) or short programs in [R](https://stackoverflow.com/q/58604195/3726673), [python](https://stackoverflow.com/q/2323128/3726673), or another language of your choice.\r\n * It also records all of the individual strokes that the participant made during the trial.\r\n *\r\n * !!! warning\r\n *     This plugin generates **a lot** of data. Each trial can easily add 500kb+ of data to a final JSON output.\r\n *     You can reduce the amount of data generated by turning off storage of the individual stroke data (`save_strokes: false`) or storage of the final image (`save_final_image: false`) if your use case doesn't require that information.\r\n *     If you are going to be collecting a lot of data with this plugin you may want to save your data to your server after each trial and not wait until the end of the experiment to perform a single bulk upload.\r\n *     You can do this by putting data saving code inside the [`on_data_update` event handler](../overview/events.md#on_data_update).\r\n *\r\n *\r\n * @author Josh de Leeuw\r\n * @see {@link https://www.jspsych.org/latest/plugins/sketchpad/ sketchpad plugin documentation on jspsych.org}\r\n */\r\nclass SketchpadPlugin implements JsPsychPlugin<Info> {\r\n  static info = info;\r\n  private display: HTMLElement;\r\n  private params: TrialType<Info>;\r\n  private sketchpad: HTMLCanvasElement;\r\n  private is_drawing = false;\r\n  private ctx: CanvasRenderingContext2D;\r\n  private trial_finished_handler;\r\n  private background_image;\r\n  private strokes = [];\r\n  private stroke = [];\r\n  private undo_history = [];\r\n  private current_stroke_color;\r\n  private start_time;\r\n  private mouse_position = { x: 0, y: 0 };\r\n  private draw_key_held = false;\r\n  private timer_interval;\r\n\r\n  constructor(private jsPsych: JsPsych) {}\r\n\r\n  trial(display_element: HTMLElement, trial: TrialType<Info>, on_load: () => void) {\r\n    this.display = display_element;\r\n    this.params = trial;\r\n    this.current_stroke_color = trial.stroke_color;\r\n\r\n    this.init_display();\r\n\r\n    this.setup_event_listeners();\r\n\r\n    this.add_background_color();\r\n    this.add_background_image().then(() => {\r\n      on_load();\r\n    });\r\n\r\n    this.start_time = performance.now();\r\n    this.set_trial_duration_timer();\r\n\r\n    return new Promise((resolve, reject) => {\r\n      this.trial_finished_handler = resolve;\r\n    });\r\n  }\r\n\r\n  private init_display() {\r\n    this.add_css();\r\n\r\n    let canvas_html;\r\n    if (this.params.canvas_shape == \"rectangle\") {\r\n      canvas_html = `\r\n        <canvas id=\"sketchpad-canvas\" \r\n        width=\"${this.params.canvas_width}\" \r\n        height=\"${this.params.canvas_height}\" \r\n        class=\"sketchpad-rectangle\"></canvas>\r\n      `;\r\n    } else if (this.params.canvas_shape == \"circle\") {\r\n      canvas_html = `\r\n        <canvas id=\"sketchpad-canvas\" \r\n        width=\"${this.params.canvas_diameter}\" \r\n        height=\"${this.params.canvas_diameter}\" \r\n        class=\"sketchpad-circle\">\r\n        </canvas>\r\n      `;\r\n    } else {\r\n      throw new Error(\r\n        '`canvas_shape` parameter in sketchpad plugin must be either \"rectangle\" or \"circle\"'\r\n      );\r\n    }\r\n\r\n    let sketchpad_controls = `<div id=\"sketchpad-controls\">`;\r\n\r\n    sketchpad_controls += `<div id=\"sketchpad-color-palette\">`;\r\n    for (const color of this.params.stroke_color_palette) {\r\n      sketchpad_controls += `<button class=\"sketchpad-color-select\" data-color=\"${color}\" style=\"background-color:${color};\"></button>`;\r\n    }\r\n    sketchpad_controls += `</div>`;\r\n\r\n    sketchpad_controls += `<div id=\"sketchpad-actions\">`;\r\n    if (this.params.show_clear_button) {\r\n      sketchpad_controls += `<button class=\"jspsych-btn\" id=\"sketchpad-clear\" disabled>${this.params.clear_button_label}</button>`;\r\n    }\r\n    if (this.params.show_undo_button) {\r\n      sketchpad_controls += `<button class=\"jspsych-btn\" id=\"sketchpad-undo\" disabled>${this.params.undo_button_label}</button>`;\r\n      if (this.params.show_redo_button) {\r\n        sketchpad_controls += `<button class=\"jspsych-btn\" id=\"sketchpad-redo\" disabled>${this.params.redo_button_label}</button>`;\r\n      }\r\n    }\r\n    sketchpad_controls += `</div></div>`;\r\n\r\n    canvas_html += sketchpad_controls;\r\n\r\n    let finish_button_html = \"\";\r\n    if (this.params.show_finished_button) {\r\n      finish_button_html = `<p id=\"finish-btn\"><button class=\"jspsych-btn\" id=\"sketchpad-end\">${this.params.finished_button_label}</button></p>`;\r\n    }\r\n\r\n    let timer_html = \"\";\r\n    if (this.params.show_countdown_trial_duration && this.params.trial_duration) {\r\n      timer_html = `<p id=\"countdown-timer\">${this.params.countdown_timer_html}</p>`;\r\n    }\r\n\r\n    let display_html;\r\n    if (this.params.prompt !== null) {\r\n      if (this.params.prompt_location == \"abovecanvas\") {\r\n        display_html = this.params.prompt + timer_html + canvas_html + finish_button_html;\r\n      }\r\n      if (this.params.prompt_location == \"belowcanvas\") {\r\n        display_html = timer_html + canvas_html + this.params.prompt + finish_button_html;\r\n      }\r\n      if (this.params.prompt_location == \"belowbutton\") {\r\n        display_html = timer_html + canvas_html + finish_button_html + this.params.prompt;\r\n      }\r\n    } else {\r\n      display_html = timer_html + canvas_html + finish_button_html;\r\n    }\r\n\r\n    this.display.innerHTML = display_html;\r\n\r\n    this.sketchpad = this.display.querySelector(\"#sketchpad-canvas\");\r\n    this.ctx = this.sketchpad.getContext(\"2d\");\r\n  }\r\n\r\n  private setup_event_listeners() {\r\n    document.addEventListener(\"pointermove\", (e) => {\r\n      this.mouse_position = { x: e.clientX, y: e.clientY };\r\n    });\r\n\r\n    if (this.params.show_finished_button) {\r\n      this.display.querySelector(\"#sketchpad-end\").addEventListener(\"click\", () => {\r\n        this.end_trial(\"button\");\r\n      });\r\n    }\r\n\r\n    this.sketchpad.addEventListener(\"pointerdown\", this.start_draw.bind(this));\r\n    this.sketchpad.addEventListener(\"pointermove\", this.move_draw.bind(this));\r\n    this.sketchpad.addEventListener(\"pointerup\", this.end_draw.bind(this));\r\n    this.sketchpad.addEventListener(\"pointerleave\", this.end_draw.bind(this));\r\n    this.sketchpad.addEventListener(\"pointercancel\", this.end_draw.bind(this));\r\n\r\n    if (this.params.key_to_draw !== null) {\r\n      document.addEventListener(\"keydown\", (e) => {\r\n        if (e.key == this.params.key_to_draw && !this.is_drawing && !this.draw_key_held) {\r\n          this.draw_key_held = true;\r\n          if (\r\n            document.elementFromPoint(this.mouse_position.x, this.mouse_position.y) ==\r\n            this.sketchpad\r\n          ) {\r\n            this.sketchpad.dispatchEvent(\r\n              new PointerEvent(\"pointerdown\", {\r\n                clientX: this.mouse_position.x,\r\n                clientY: this.mouse_position.y,\r\n              })\r\n            );\r\n          }\r\n        }\r\n      });\r\n\r\n      document.addEventListener(\"keyup\", (e) => {\r\n        if (e.key == this.params.key_to_draw) {\r\n          this.draw_key_held = false;\r\n          if (\r\n            document.elementFromPoint(this.mouse_position.x, this.mouse_position.y) ==\r\n            this.sketchpad\r\n          ) {\r\n            this.sketchpad.dispatchEvent(\r\n              new PointerEvent(\"pointerup\", {\r\n                clientX: this.mouse_position.x,\r\n                clientY: this.mouse_position.y,\r\n              })\r\n            );\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    if (this.params.show_undo_button) {\r\n      this.display.querySelector(\"#sketchpad-undo\").addEventListener(\"click\", this.undo.bind(this));\r\n      if (this.params.show_redo_button) {\r\n        this.display\r\n          .querySelector(\"#sketchpad-redo\")\r\n          .addEventListener(\"click\", this.redo.bind(this));\r\n      }\r\n    }\r\n    if (this.params.show_clear_button) {\r\n      this.display\r\n        .querySelector(\"#sketchpad-clear\")\r\n        .addEventListener(\"click\", this.clear.bind(this));\r\n    }\r\n\r\n    const color_btns = Array.prototype.slice.call(\r\n      this.display.querySelectorAll(\".sketchpad-color-select\")\r\n    );\r\n    for (const btn of color_btns) {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        const target = e.target as HTMLButtonElement;\r\n        this.current_stroke_color = target.getAttribute(\"data-color\");\r\n      });\r\n    }\r\n\r\n    this.jsPsych.pluginAPI.getKeyboardResponse({\r\n      callback_function: this.after_key_response,\r\n      valid_responses: this.params.choices,\r\n      persist: false,\r\n      allow_held_key: false,\r\n    });\r\n  }\r\n\r\n  private add_css() {\r\n    document.querySelector(\"head\").insertAdjacentHTML(\r\n      \"beforeend\",\r\n      `<style id=\"sketchpad-styles\">\r\n        #sketchpad-controls {\r\n          line-height: 1; \r\n          width:${\r\n            this.params.canvas_shape == \"rectangle\"\r\n              ? this.params.canvas_width + this.params.canvas_border_width * 2\r\n              : this.params.canvas_diameter + this.params.canvas_border_width * 2\r\n          }px; \r\n          display: flex; \r\n          justify-content: space-between; \r\n          flex-wrap: wrap;\r\n          margin: auto;\r\n        }\r\n        #sketchpad-color-palette { \r\n          display: inline-block; text-align:left; flex-grow: 1;\r\n        }\r\n        .sketchpad-color-select { \r\n          cursor: pointer; height: 33px; width: 33px; border-radius: 4px; padding: 0; border: 1px solid #ccc; \r\n        }\r\n        #sketchpad-actions {\r\n          display:inline-block; text-align:right; flex-grow: 1;\r\n        }\r\n        #sketchpad-actions button {\r\n          margin-left: 4px;\r\n        }\r\n        #sketchpad-canvas {\r\n          touch-action: none;\r\n          border: ${this.params.canvas_border_width}px solid ${this.params.canvas_border_color};\r\n        }\r\n        .sketchpad-circle {\r\n          border-radius: ${this.params.canvas_diameter / 2}px;\r\n        }\r\n        #countdown-timer {\r\n          width:${\r\n            this.params.canvas_shape == \"rectangle\"\r\n              ? this.params.canvas_width + this.params.canvas_border_width * 2\r\n              : this.params.canvas_diameter + this.params.canvas_border_width * 2\r\n          }px; \r\n          text-align: right;\r\n          font-size: 12px; \r\n          margin-bottom: 0.2em;\r\n        }\r\n      </style>`\r\n    );\r\n  }\r\n\r\n  private add_background_color() {\r\n    this.ctx.fillStyle = this.params.background_color;\r\n    if (this.params.canvas_shape == \"rectangle\") {\r\n      this.ctx.fillRect(0, 0, this.params.canvas_width, this.params.canvas_height);\r\n    }\r\n    if (this.params.canvas_shape == \"circle\") {\r\n      this.ctx.fillRect(0, 0, this.params.canvas_diameter, this.params.canvas_diameter);\r\n    }\r\n  }\r\n\r\n  private add_background_image() {\r\n    return new Promise((resolve, reject) => {\r\n      if (this.params.background_image !== null) {\r\n        this.background_image = new Image();\r\n        this.background_image.src = this.params.background_image;\r\n        this.background_image.onload = () => {\r\n          this.ctx.drawImage(this.background_image, 0, 0);\r\n          resolve(true);\r\n        };\r\n      } else {\r\n        resolve(false);\r\n      }\r\n    });\r\n  }\r\n\r\n  private start_draw(e) {\r\n    this.is_drawing = true;\r\n\r\n    const x = Math.round(e.clientX - this.sketchpad.getBoundingClientRect().left);\r\n    const y = Math.round(e.clientY - this.sketchpad.getBoundingClientRect().top);\r\n\r\n    this.undo_history = [];\r\n    this.set_redo_btn_state(false);\r\n\r\n    this.ctx.beginPath();\r\n    this.ctx.moveTo(x, y);\r\n    this.ctx.strokeStyle = this.current_stroke_color;\r\n    this.ctx.lineJoin = \"round\";\r\n    this.ctx.lineWidth = this.params.stroke_width;\r\n    this.stroke = [];\r\n    this.stroke.push({\r\n      x: x,\r\n      y: y,\r\n      color: this.current_stroke_color,\r\n      action: \"start\",\r\n      t: Math.round(performance.now() - this.start_time),\r\n    });\r\n\r\n    this.sketchpad.releasePointerCapture(e.pointerId);\r\n  }\r\n\r\n  private move_draw(e) {\r\n    if (this.is_drawing) {\r\n      const x = Math.round(e.clientX - this.sketchpad.getBoundingClientRect().left);\r\n      const y = Math.round(e.clientY - this.sketchpad.getBoundingClientRect().top);\r\n\r\n      this.ctx.lineTo(x, y);\r\n      this.ctx.stroke();\r\n      this.stroke.push({\r\n        x: x,\r\n        y: y,\r\n        action: \"move\",\r\n      });\r\n    }\r\n  }\r\n\r\n  private end_draw(e) {\r\n    if (this.is_drawing) {\r\n      this.stroke.push({\r\n        action: \"end\",\r\n        t: Math.round(performance.now() - this.start_time),\r\n      });\r\n      this.strokes.push(this.stroke);\r\n      this.set_undo_btn_state(true);\r\n      this.set_clear_btn_state(true);\r\n    }\r\n    this.is_drawing = false;\r\n  }\r\n\r\n  private render_drawing() {\r\n    this.ctx.clearRect(0, 0, this.sketchpad.width, this.sketchpad.height);\r\n    this.add_background_color();\r\n    if (this.background_image) {\r\n      this.ctx.drawImage(this.background_image, 0, 0);\r\n    }\r\n    for (const stroke of this.strokes) {\r\n      for (const m of stroke) {\r\n        if (m.action == \"start\") {\r\n          this.ctx.beginPath();\r\n          this.ctx.moveTo(m.x, m.y);\r\n          this.ctx.strokeStyle = m.color;\r\n          this.ctx.lineJoin = \"round\";\r\n          this.ctx.lineWidth = this.params.stroke_width;\r\n        }\r\n        if (m.action == \"move\") {\r\n          this.ctx.lineTo(m.x, m.y);\r\n          this.ctx.stroke();\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private undo() {\r\n    this.undo_history.push(this.strokes.pop());\r\n    this.set_redo_btn_state(true);\r\n    if (this.strokes.length == 0) {\r\n      this.set_undo_btn_state(false);\r\n    }\r\n    this.render_drawing();\r\n  }\r\n\r\n  private redo() {\r\n    this.strokes.push(this.undo_history.pop());\r\n    this.set_undo_btn_state(true);\r\n    if (this.undo_history.length == 0) {\r\n      this.set_redo_btn_state(false);\r\n    }\r\n    this.render_drawing();\r\n  }\r\n\r\n  private clear() {\r\n    this.strokes = [];\r\n    this.undo_history = [];\r\n    this.render_drawing();\r\n    this.set_redo_btn_state(false);\r\n    this.set_undo_btn_state(false);\r\n    this.set_clear_btn_state(false);\r\n  }\r\n\r\n  private set_undo_btn_state(enabled: boolean) {\r\n    if (this.params.show_undo_button) {\r\n      (this.display.querySelector(\"#sketchpad-undo\") as HTMLButtonElement).disabled = !enabled;\r\n    }\r\n  }\r\n\r\n  private set_redo_btn_state(enabled: boolean) {\r\n    if (this.params.show_undo_button && this.params.show_redo_button) {\r\n      (this.display.querySelector(\"#sketchpad-redo\") as HTMLButtonElement).disabled = !enabled;\r\n    }\r\n  }\r\n\r\n  private set_clear_btn_state(enabled: boolean) {\r\n    if (this.params.show_clear_button) {\r\n      (this.display.querySelector(\"#sketchpad-clear\") as HTMLButtonElement).disabled = !enabled;\r\n    }\r\n  }\r\n\r\n  private set_trial_duration_timer() {\r\n    if (this.params.trial_duration !== null) {\r\n      this.jsPsych.pluginAPI.setTimeout(() => {\r\n        this.end_trial();\r\n      }, this.params.trial_duration);\r\n      if (this.params.show_countdown_trial_duration) {\r\n        this.timer_interval = setInterval(() => {\r\n          const remaining = this.params.trial_duration - (performance.now() - this.start_time);\r\n          let minutes = Math.floor(remaining / 1000 / 60);\r\n          let seconds = Math.ceil((remaining - minutes * 1000 * 60) / 1000);\r\n          if (seconds == 60) {\r\n            seconds = 0;\r\n            minutes++;\r\n          }\r\n          const minutes_str = minutes.toString();\r\n          const seconds_str = seconds.toString().padStart(2, \"0\");\r\n          const timer_span = this.display.querySelector(\"#sketchpad-timer\");\r\n          if (timer_span) {\r\n            timer_span.innerHTML = `${minutes_str}:${seconds_str}`;\r\n          }\r\n          if (remaining <= 0) {\r\n            if (timer_span) {\r\n              timer_span.innerHTML = `0:00`;\r\n            }\r\n            clearInterval(this.timer_interval);\r\n          }\r\n        }, 250);\r\n      }\r\n    }\r\n  }\r\n\r\n  private after_key_response(info) {\r\n    this.end_trial(info.key);\r\n  }\r\n\r\n  private end_trial(response = null) {\r\n    this.jsPsych.pluginAPI.cancelAllKeyboardResponses();\r\n    clearInterval(this.timer_interval);\r\n\r\n    const trial_data = <any>{};\r\n\r\n    trial_data.rt = Math.round(performance.now() - this.start_time);\r\n    trial_data.response = response;\r\n\r\n    if (this.params.save_final_image) {\r\n      trial_data.png = this.sketchpad.toDataURL();\r\n    }\r\n\r\n    if (this.params.save_strokes) {\r\n      trial_data.strokes = this.strokes;\r\n    }\r\n\r\n    document.querySelector(\"#sketchpad-styles\").remove();\r\n\r\n    this.jsPsych.finishTrial(trial_data);\r\n\r\n    this.trial_finished_handler();\r\n  }\r\n}\r\n\r\nexport default SketchpadPlugin;\r\n"],"names":[],"mappings":";;;EAEE,IAAW,OAAA,GAAA,OAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ICgQA,SAAA,EAAA;EAAA;;KAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}